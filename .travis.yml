os: linux
dist: xenial
language: node_js
jobs:
  include:
  - os: linux
    node_js: 12
  - os: osx
    node_js: 12
addons:
  chrome: stable
  firefox: latest
services:
- xvfb
script:
- npm run ci
before_deploy:
- sed -i 's/"private":\ true/"private":\ false/' package.json
- sed -i -E 's/^dist\/?.*$//' .gitignore
deploy:
  provider: npm
  edge: true
  email:
    secure: "vFku2HASiG87+c4zdfjnMgNzDm6olPOUG5fgN3NcfRP2/vZLuT2l1M3OaZ94DGaTTEJ7slFfoBRCoYJ3o0N2AEHTFo52XtTE8cN2T9rdbUZ9O7fskRFipiM6xGF6WZHFBdslBCrPGor60IRKeUh5yxa8L9+iJlCBiKVb9rGpPEAWaW0/tYh99pu1S+oMuyaiYw6/HvpXR6VmzYcnj7ky4J8XRcyENuFY5tPbCZ09CAlDmRjivTvfT9BgGMXViOgNtDXPP2+g1cbGnSsAf6Yo2Zy8/Ax38hnqW8fft7bI3/fCEbUQeNW2tc6jxjRigJ6AXssmoRAD9LmLw5cwsLx05EN2Blm+rSiZ84hR8O4pj55Nw0itAQLrFTAQ6oVPdIcEy2xtO2OHxcW0WMvVL6FhR38Ik2vOZY/wKTHyCxHF1YQXFLSfS0+QqxYC4KlcybWtSHjwjBdJto4y2jenNno+Ge1TJI1mHHRIuFig4oVzxnVl48CNoR6u8y/cNnZKovbHLefMBNi8usJQj6620CUd8uTk1Q4EfIM7xaq4Gitt0YhzRK63JqjwG/gDu5421FdyATqd3GMb9DHK1YqHgA2PJLf5ODSSFAGCBZTulWJpcnqaKijpjWCBb8PEeS7rBYBDvEHWMwaENpJxPODvztsQXyOFfiPhRp9r8BL2graGQoo="
  api_token:
    secure: "RklNamWHwytYRdjkdaoFJb19lgMt0aYQVNu8g8B2dtJIRzjUOlptv5rA9i9nB8+1Xl87qbSOgOYM0ngfQQj5hGhDB7YbUtBuCj83h13h3rBxJM1MQjIdruMBP/R/KjViqNyg2mUx+VBpjJAKp3S1wKLFBuqEpSkbmZBkVprz8NXEaDjRKX/3OleqgKJ5X6qsD+O3HNmUVxf6pzDt7jxq/CiDn/ULKryRwjmiyVL1CQSMa03WyWQI9TULHPV1SFCgeeRHjMmOUMuEvwTPsc/8LcHrG/Yd5dB3FdaWHEzI+MNetcAzKdL5bWXTLNnzg/JnLKElZnLgb7HNCoBD5pxVtOOP0wZC+xxniUkAzvR7MdP281rjU462SU0Hmn9YmTEtUUgVleInTd0sx/tOakaH6u/r3Fpg+bikOOgRGq4Lk8tWXCVR0AlRTIm3oY86EC7JuGG+utGBiO1rF5Uj1OzQMYcVizojkTn0APImwOEcGgPcspVvRxO2aSzLX6JtrGHXdj/jELJfjVhPTQk8TSDJK2NedOLzLe3r1Jh6INzY4cTvOnT6DRQ3+K1hP3zFosUC9j0RoWVxCR4t6dbZ0IBDjMCzNOy4WV5K7WMjClr8NLIVNuXaj4tQoFkBnIcCFxCcn1cwFpJrdL3vT4fdhC6JgFVgW+39nXxrBPC8VCPH9Vo="
  on:
    node_js: 12
    condition:
    - $TRAVIS_BRANCH = master
    - $TRAVIS_EVENT_TYPE = push
    - $TRAVIS_COMMIT_MESSAGE =~ ^v[0-9]+(\.[0-9]+)*($|\n)
    - $TRAVIS_OS_NAME = linux
notifications:
  email:
    recipients:
    - secure: "vFku2HASiG87+c4zdfjnMgNzDm6olPOUG5fgN3NcfRP2/vZLuT2l1M3OaZ94DGaTTEJ7slFfoBRCoYJ3o0N2AEHTFo52XtTE8cN2T9rdbUZ9O7fskRFipiM6xGF6WZHFBdslBCrPGor60IRKeUh5yxa8L9+iJlCBiKVb9rGpPEAWaW0/tYh99pu1S+oMuyaiYw6/HvpXR6VmzYcnj7ky4J8XRcyENuFY5tPbCZ09CAlDmRjivTvfT9BgGMXViOgNtDXPP2+g1cbGnSsAf6Yo2Zy8/Ax38hnqW8fft7bI3/fCEbUQeNW2tc6jxjRigJ6AXssmoRAD9LmLw5cwsLx05EN2Blm+rSiZ84hR8O4pj55Nw0itAQLrFTAQ6oVPdIcEy2xtO2OHxcW0WMvVL6FhR38Ik2vOZY/wKTHyCxHF1YQXFLSfS0+QqxYC4KlcybWtSHjwjBdJto4y2jenNno+Ge1TJI1mHHRIuFig4oVzxnVl48CNoR6u8y/cNnZKovbHLefMBNi8usJQj6620CUd8uTk1Q4EfIM7xaq4Gitt0YhzRK63JqjwG/gDu5421FdyATqd3GMb9DHK1YqHgA2PJLf5ODSSFAGCBZTulWJpcnqaKijpjWCBb8PEeS7rBYBDvEHWMwaENpJxPODvztsQXyOFfiPhRp9r8BL2graGQoo="
    on_success: change
    on_failure: always
after_script:
- |
  if
    [ $TRAVIS_BRANCH == "master" ]
    [ $TRAVIS_EVENT_TYPE == "push" ]
    [ $TRAVIS_OS_NAME == "linux" ]
    [ $ENCRYPTION_LABEL ]
  then :; else exit 0; fi
- eval `ssh-agent -s`
- openssl aes-256-cbc -K `eval echo $\{${ENCRYPTION_LABEL}_key\}` -iv `eval echo $\{${ENCRYPTION_LABEL}_iv\}` -in .travis/deploy_key.enc -d | ssh-add -
- gulp site
- mkdir ../gh-pages
- cp -rf ./gh-pages ../
- cat package.json | json version
- new_version=$(cat package.json | json version)
- git reset --hard HEAD~
- cat package.json | json version
- old_version=$(cat package.json | json version)
- git reset --hard ORIG_HEAD
- node -e 'if (!require("semver").gt(process.argv[1], process.argv[2])) process.exit(1)' $new_version $old_version || exit 0
- git fetch origin gh-pages:gh-pages
- git checkout --orphan gh-pages
- git checkout -m gh-pages
- ls -a | grep -vE "^.git$|^\.+$" | xargs rm -rf
- cp -rf ../gh-pages/* ./
- find | grep -vE "^./.git(/|$)"
- sed -i 's|\(baseurl:\s\+\)|\1//falsandtru.github.io|' _config.yml
- git add -A
- git commit -m "Update web contents" --author "Travis-CI"
- git push git@github.com:${TRAVIS_REPO_SLUG} gh-pages:gh-pages
