/*! localsocket v0.4.3 https://github.com/falsandtru/localsocket | (c) 2016, falsandtru | MIT License */
define="function"==typeof define&&define.amd?define:function(){"use strict";var e="localsocket",t={};return function n(r,o,i){return i?void i.apply(this,o.map(function(e){switch(e){case"require":return"function"==typeof require?require:void 0;case"exports":return r.indexOf("/")===-1?t[r]="undefined"==typeof exports?self[r]=self[r]||{}:exports:t[r]=t.hasOwnProperty(r)?t[r]:{};default:return".d"===e.slice(-2)&&{}||t.hasOwnProperty(e)&&t[e]||"function"==typeof require&&require(e)||self[e]}})):void n(e,r,o)}}();var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)};define("src/layer/data/constraint/values",["require","exports"],function(e,t){"use strict";function n(e){return e.length>0&&"_"!==e[0]&&"_"!==e[e.length-1]&&!i.test(e)&&o.test(e)}function r(e){return function(t){switch(typeof e[t]){case"undefined":case"boolean":case"number":case"string":case"object":return!0;default:return!1}}}var o=/^[A-z][0-9A-z_]*$/,i=/^[0-9A-Z_]+$/;t.isValidName=n,t.isValidValue=r}),define("src/lib/noop",["require","exports"],function(e,t){"use strict";function n(){}t.noop=n}),define("src/layer/domain/dao/module/builder",["require","exports","src/layer/data/constraint/values","src/lib/noop"],function(e,t,n,r){"use strict";function o(e,o,i){void 0===i&&(i=r.noop);var s=o();if(void Object.keys(t.SCHEMA).map(function(e){return t.SCHEMA[e].NAME}).reduce(function(e,t){delete s[t]},void 0),"string"!=typeof e[t.SCHEMA.KEY.NAME])throw new TypeError("LocalSocket: Invalid key: "+e[t.SCHEMA.KEY.NAME]);var a=Object.assign(Object.keys(s).filter(n.isValidName).filter(n.isValidValue(s)).reduce(function(t,r){var o=Object.getOwnPropertyDescriptor(s,r);if(o&&(o.get||o.set))return t;var a=s[r];return void 0===e[r]&&(e[r]=a),t[r]={enumerable:!0,get:function(){return void 0===e[r]?a:e[r]},set:function(t){var o=e[r];n.isValidValue(e)(r)&&(t===o&&t instanceof Object==!1||(e[r]=void 0===t?a:t,void i(r,t,o)))}},t},{}),(c={},c[t.SCHEMA.META.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.META.NAME]}},c[t.SCHEMA.ID.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.ID.NAME]}},c[t.SCHEMA.KEY.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.KEY.NAME]}},c[t.SCHEMA.DATE.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.DATE.NAME]}},c[t.SCHEMA.EVENT.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.EVENT.NAME]}},c));return void Object.defineProperties(s,a),void Object.seal(s),s;var c}t.isValidPropertyName=n.isValidName,t.isValidPropertyValue=n.isValidValue,t.SCHEMA={META:{NAME:"__meta"},ID:{NAME:"__id"},KEY:{NAME:"__key"},DATE:{NAME:"__date"},EVENT:{NAME:"__event"}},t.build=o}),define("src/layer/domain/dao/api",["require","exports","src/layer/domain/dao/module/builder"],function(e,t,n){"use strict";t.SCHEMA=n.SCHEMA,t.build=n.build,t.isValidPropertyName=n.isValidPropertyName,t.isValidPropertyValue=n.isValidPropertyValue}),define("src/layer/infrastructure/indexeddb/module/global",["require","exports"],function(e,t){"use strict";t.indexedDB=self.indexedDB,t.IDBKeyRange=self.IDBKeyRange;var n;!function(e){e.readonly="readonly",e.readwrite="readwrite"}(n=t.IDBTransactionMode||(t.IDBTransactionMode={}));var r;!function(e){e.next="next",e.nextunique="nextunique",e.prev="prev",e.prevunique="prevunique"}(r=t.IDBCursorDirection||(t.IDBCursorDirection={}))}),define("src/layer/infrastructure/indexeddb/model/event",["require","exports"],function(e,t){"use strict";var n;!function(e){e.connect="connect",e.disconnect="disconnect",e.block="block",e.error="error",e.abort="abort",e.crash="crash",e.destroy="destroy"}(n=t.IDBEventType||(t.IDBEventType={}));var r=function(){function e(e,t){this.type=e,this.name=t,this.namespace=[this.name],void Object.freeze(this)}return e}();t.IDBEvent=r}),define("src/layer/infrastructure/indexeddb/model/access",["require","exports","spica","src/layer/infrastructure/indexeddb/module/global","src/layer/infrastructure/indexeddb/model/event"],function(e,t,n,r,o){"use strict";function i(e,n){void f.set(e,0),void t.ConfigMap.set(e,n),y.has(e)||void d(new l.Initial(e))}function s(e){return function(t){var n=p.get(e)||p.set(e,[]).get(e);void n.push(t);var r=y.get(e);r instanceof l.Success&&void r.drain()}}function a(e){return void f.set(e,1),void t.ConfigMap.set(e,{make:function(){return!1},verify:function(){return!1},destroy:function(){return!1}}),y.get(e)instanceof l.Success?y.get(e).end():void(y.has(e)||void d(new l.Initial(e)))}function c(e){return void f.set(e,2),void t.ConfigMap.set(e,{make:function(){return!1},verify:function(){return!1},destroy:function(){return!0}}),y.get(e)instanceof l.Success?y.get(e).destroy():void(y.has(e)||void d(new l.Initial(e)))}function d(e,n){function i(e){var t=e.database;void u.emit([t,o.IDBEventType.block],new o.IDBEvent(o.IDBEventType.block,t))}function s(e){var n=e.database,r=e.session,o=r.transaction.db,i=t.ConfigMap.get(n),s=i.make,d=i.destroy;try{s(o)?(r.onsuccess=function(){return void a(new l.Success(n,o))},r.onerror=function(e){return void c(new l.Error(n,r.error,e))}):r.onsuccess=r.onerror=function(e){return void o.close(),d(r.error,e)?void E(new l.Destroy(n)):void m(new l.End(n))}}catch(e){void h(new l.Crash(n,e))}}function a(e){var n=e.database,r=e.connection,i=function(){return r.onversionchange=function(){return void r.close()},r.onerror=void 0,r.onabort=void 0,r.onclose=void 0};switch(r.onversionchange=function(t){var s=t.newVersion;void i(),void r.close(),s||(void p.delete(n),void u.emit([n,o.IDBEventType.destroy],new o.IDBEvent(o.IDBEventType.destroy,n))),y.get(n)===e&&void m(new l.End(n))},r.onerror=function(e){return void i(),void c(new l.Error(n,e.target.error,e))},r.onabort=function(e){return void i(),void v(new l.Abort(n,e.target.error,e))},r.onclose=function(){return void i(),void u.emit([n,o.IDBEventType.destroy],new o.IDBEvent(o.IDBEventType.destroy,n)),y.get(n)===e?void m(new l.End(n)):void 0},e.destroy=function(){return void i(),void r.close(),void E(new l.Destroy(n))},e.end=function(){return void i(),void r.close(),void m(new l.End(n))},e.drain=function(){var e=p.get(n)||[];try{for(;e.length>0&&0===f.get(n);)void e[0](r),void e.shift()}catch(e){e instanceof DOMError||e instanceof DOMException?void console.warn(e):void console.error(e),void i(),void h(new l.Crash(n,e))}},f.get(n)){case 0:var s=t.ConfigMap.get(n).verify;try{if(!s(r))return void m(new l.End(n),r.version+1)}catch(e){return void h(new l.Crash(n,e))}return void u.emit([n,o.IDBEventType.connect],new o.IDBEvent(o.IDBEventType.connect,n)),void e.drain();case 1:return void e.end();case 2:return void e.destroy()}throw new TypeError("LocalSocket: Invalid command "+f.get(n)+".")}function c(e){var n=e.database,r=e.error,i=e.event;void i.preventDefault(),void u.emit([n,o.IDBEventType.error],new o.IDBEvent(o.IDBEventType.error,n));var s=t.ConfigMap.get(n).destroy;return s(r,i)?void E(new l.Destroy(n)):void m(new l.End(n))}function v(e){var n=e.database,r=e.error,i=e.event;void i.preventDefault(),void u.emit([n,o.IDBEventType.abort],new o.IDBEvent(o.IDBEventType.abort,n));var s=t.ConfigMap.get(n).destroy;return s(r,i)?void E(new l.Destroy(n)):void m(new l.End(n))}function h(e){var n=e.database,r=e.error;void u.emit([n,o.IDBEventType.crash],new o.IDBEvent(o.IDBEventType.crash,n));var i=t.ConfigMap.get(n).destroy;return i(r,null)?void E(new l.Destroy(n)):void m(new l.End(n))}function E(e){var t=e.database,n=r.indexedDB.deleteDatabase(t);n.onsuccess=function(){return void p.delete(t),void u.emit([t,o.IDBEventType.destroy],new o.IDBEvent(o.IDBEventType.destroy,t)),void m(new l.End(t))},n.onerror=function(e){return void c(new l.Error(t,n.error,e))}}function m(e,n){var r=e.database;switch(void 0===n&&(n=0),void y.delete(r),f.get(r)){case 0:return void d(new l.Initial(r),n);case 1:return void f.delete(r),void t.ConfigMap.delete(r),void u.emit([r,o.IDBEventType.disconnect],new o.IDBEvent(o.IDBEventType.disconnect,r));case 2:return void f.delete(r),void t.ConfigMap.delete(r),void u.emit([r,o.IDBEventType.disconnect],new o.IDBEvent(o.IDBEventType.disconnect,r))}throw new TypeError("LocalSocket: Invalid command "+f.get(r)+".")}var b=e.database;void 0===n&&(n=0);t.ConfigMap.get(b);try{var g=n?r.indexedDB.open(b,n):r.indexedDB.open(b),S=function(){return g.onupgradeneeded=void 0,g.onsuccess=void 0,g.onerror=void 0};g.onblocked=function(){return void i(new l.Block(b))},g.onupgradeneeded=function(){return void S(),void s(new l.Upgrade(b,g))},g.onsuccess=function(){return void S(),void a(new l.Success(b,g.result))},g.onerror=function(e){return void S(),void c(new l.Error(b,g.error,e))}}catch(e){void h(new l.Crash(b,e))}}var u=new n.Observable;t.event=u,t.ConfigMap=new Map;var v,f=new Map;!function(e){e[e.open=0]="open",e[e.close=1]="close",e[e.destroy=2]="destroy"}(v||(v={}));var l,y=new Map;!function(e){var t=function(){function e(e){this.database=e,this.STATE,void y.set(e,this)}return e}();e.Initial=t;var n=function(){function e(e){this.database=e,this.STATE,void y.set(e,this)}return e}();e.Block=n;var r=function(){function e(e,t){this.database=e,this.session=t,this.STATE,void y.set(e,this)}return e}();e.Upgrade=r;var o=function(){function e(e,t){this.database=e,this.connection=t,this.STATE,void y.set(e,this)}return e}();e.Success=o;var i=function(){function e(e,t,n){this.database=e,this.error=t,this.event=n,this.STATE,void y.set(e,this)}return e}();e.Error=i;var s=function(){function e(e,t,n){this.database=e,this.error=t,this.event=n,this.STATE,void y.set(e,this)}return e}();e.Abort=s;var a=function(){function e(e,t){this.database=e,this.error=t,this.STATE,void y.set(e,this)}return e}();e.Crash=a;var c=function(){function e(e){this.database=e,this.STATE,void y.set(e,this)}return e}();e.Destroy=c;var d=function(){function e(e){this.database=e,this.STATE,void y.set(e,this)}return e}();e.End=d}(l||(l={}));var p=new Map;t.open=i,t.listen=s,t.close=a,t.destroy=c}),define("src/layer/infrastructure/indexeddb/api",["require","exports","src/layer/infrastructure/indexeddb/module/global","src/layer/infrastructure/indexeddb/model/access","src/layer/infrastructure/indexeddb/model/event"],function(e,t,n,r,o){"use strict";t.indexedDB=n.indexedDB,t.IDBKeyRange=n.IDBKeyRange,t.IDBTransactionMode=n.IDBTransactionMode,t.IDBCursorDirection=n.IDBCursorDirection,t.open=r.open,t.listen=r.listen,t.close=r.close,t.destroy=r.destroy,t.event=r.event,t.IDBEvent=o.IDBEvent,t.IDBEventType=o.IDBEventType}),define("src/layer/data/constraint/types",["require","exports"],function(e,t){"use strict";function n(e){return+e}t.IdNumber=n}),define("src/layer/data/schema/event",["require","exports","spica"],function(e,t,n){"use strict";var r;!function(e){e.id="id",e.key="key",e.type="type",e.attr="attr",e.value="value",e.date="date",e.surrogateKeyDateField="key+date"}(r=t.EventRecordFields||(t.EventRecordFields={}));var o=function(){function e(e,r,o,i){if("number"==typeof this.id&&this.id>0==!1||void 0!==this.id)throw new TypeError("LocalSocket: EventRecord: Invalid event id: "+this.id);if(this.type=i,"string"!=typeof this.type)throw new TypeError("LocalSocket: EventRecord: Invalid event type: "+this.type);if(this.key=e,"string"!=typeof this.key)throw new TypeError("LocalSocket: EventRecord: Invalid event key: "+this.key);if(this.value=r,"object"!=typeof this.value||!this.value)throw new TypeError("LocalSocket: EventRecord: Invalid event value: "+this.value);if(this.date=o,"number"!=typeof this.date||this.date>=0==!1)throw new TypeError("LocalSocket: EventRecord: Invalid event date: "+this.date);if(this.attr=this.type===t.EventType.put?Object.keys(r).reduce(function(e,t){return t.length>0&&"_"!==t[0]&&"_"!==t[t.length-1]?t:e},""):"","string"!=typeof this.attr)throw new TypeError("LocalSocket: EventRecord: Invalid event attr: "+this.key);if(this.type===t.EventType.put&&0===this.attr.length)throw new TypeError("LocalSocket: EventRecord: Invalid event attr with "+this.type+": "+this.attr);if(this.type!==t.EventType.put&&0!==this.attr.length)throw new TypeError("LocalSocket: EventRecord: Invalid event attr with "+this.type+": "+this.attr);switch(i){case t.EventType.put:return this.value=r=n.clone(new a,(s={},s[this.attr]=r[this.attr],s)),void void Object.freeze(this.value);case t.EventType.snapshot:return this.value=r=n.clone(new a,r),void void Object.freeze(this.value);case t.EventType.delete:return this.value=r=new a,void void Object.freeze(this.value);default:throw new TypeError("LocalSocket: Invalid event type: "+i)}var s}return e}(),i=function(e){function n(n,r,o,i){if(void 0===o&&(o=t.EventType.put),void 0===i&&(i=Date.now()),e.call(this,n,r,i,o),this.EVENT_RECORD,void 0!==this.id||"id"in this)throw new TypeError("LocalSocket: UnsavedEventRecord: Invalid event id: "+this.id);void Object.freeze(this)}return __extends(n,e),n}(o);t.UnsavedEventRecord=i;var s=function(e){function t(t,n,r,o,i){if(e.call(this,n,r,i,o),this.id=t,this.EVENT_RECORD,this.id>0==!1)throw new TypeError("LocalSocket: SavedEventRecord: Invalid event id: "+this.id);void Object.freeze(this)}return __extends(t,e),t}(o);t.SavedEventRecord=s,t.EventType={put:"put",delete:"delete",snapshot:"snapshot"};var a=function(){function e(){}return e}();t.EventValue=a}),define("src/layer/data/store/event",["require","exports","spica","src/layer/infrastructure/indexeddb/api","src/layer/data/constraint/types","src/layer/data/schema/event","src/layer/data/schema/event","src/lib/noop"],function(e,t,n,r,o,i,s,a){"use strict";function c(e,t){function r(e){return e.map(function(e,t){return[e,t]}).sort(function(e,t){var n=e[0],r=e[1],o=t[0],i=t[1];return indexedDB.cmp(n.key,o.key)||o.date-n.date||o.id-n.id||i-r}).reduceRight(function(e,t){var r=e[0],o=e.slice(1),i=t[0],s=r[0];return s?s.key===i.key?n.concat([n.concat([i],r)],o):n.concat([[i]],n.concat([r],o)):[[i]]},[[]])}function o(e,t){switch(t.type){case d.EventType.put:return void 0!==t.value[t.attr]?new i.UnsavedEventRecord(t.key,Object.assign(new d.Value,e.value,t.value),d.EventType.snapshot):new i.UnsavedEventRecord(t.key,Object.keys(e.value).reduce(function(n,r){return r===t.attr?n:(n[r]=e[r],n)},new d.Value),d.EventType.snapshot);case d.EventType.snapshot:return t;case d.EventType.delete:return t}throw new TypeError("LocalSocket: Invalid event type: "+t)}return r(t).map(function(t){return t.reduceRight(o,new i.UnsavedEventRecord(e,new d.Value,d.EventType.delete,0))}).reduce(function(e){return e})}t.UnsavedEventRecord=i.UnsavedEventRecord,t.SavedEventRecord=i.SavedEventRecord;var d=function(){function e(t,r){var s=this;this.database=t,this.name=r,this.memory=new(function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(n.Supervisor)),this.events={load:new n.Observable,save:new n.Observable,loss:new n.Observable},this.events_={access:new n.Observable},this.syncState=new Map,this.syncWaits=new n.Observable,this.snapshotCycle=9;var a=new(function(){function e(){this.id=new Map,this.date=new Map}return e.prototype.update=function(e){void this.id.set(e.key,o.IdNumber(Math.max(e.id||0,this.id.get(e.key)||0))),void this.date.set(e.key,Math.max(e.date,this.date.get(e.key)||0))},e}());void this.memory.events.exec.monitor([],function(t){var n=t[1],r=n(void 0);r instanceof i.UnsavedEventRecord||r.date<=a.date.get(r.key)&&r.id<=a.id.get(r.key)||void s.events.load.emit([r.key,r.attr,r.type],new e.Event(r.type,r.id,r.key,r.attr,r.date))}),void this.memory.events.exec.monitor([],function(t){var n=t[1],r=n(void 0);void a.update(new e.Event(r.type,r.id||o.IdNumber(0),r.key,r.attr,r.date))}),void this.events.load.monitor([],function(e){return void a.update(e)}),void this.events.save.monitor([],function(e){return void a.update(e)}),void this.events.save.monitor([],function(t){switch(t.type){case e.EventType.delete:case e.EventType.snapshot:void s.clean(1/0,t.key)}})}return e.configure=function(e){return{make:function(t){var n=t.objectStoreNames.contains(e)?t.transaction(e).objectStore(e):t.createObjectStore(e,{keyPath:i.EventRecordFields.id,autoIncrement:!0});return n.indexNames.contains(i.EventRecordFields.id)||void n.createIndex(i.EventRecordFields.id,i.EventRecordFields.id,{unique:!0}),n.indexNames.contains(i.EventRecordFields.key)||void n.createIndex(i.EventRecordFields.key,i.EventRecordFields.key),n.indexNames.contains(i.EventRecordFields.type)||void n.createIndex(i.EventRecordFields.type,i.EventRecordFields.type),n.indexNames.contains(i.EventRecordFields.attr)||void n.createIndex(i.EventRecordFields.attr,i.EventRecordFields.attr),n.indexNames.contains(i.EventRecordFields.value)||void n.createIndex(i.EventRecordFields.value,i.EventRecordFields.value),n.indexNames.contains(i.EventRecordFields.date)||void n.createIndex(i.EventRecordFields.date,i.EventRecordFields.date),n.indexNames.contains(i.EventRecordFields.surrogateKeyDateField)||void n.createIndex(i.EventRecordFields.surrogateKeyDateField,[i.EventRecordFields.key,i.EventRecordFields.date]),!0},verify:function(t){return t.objectStoreNames.contains(e)&&t.transaction(e).objectStore(e).indexNames.contains(i.EventRecordFields.id)&&t.transaction(e).objectStore(e).indexNames.contains(i.EventRecordFields.key)&&t.transaction(e).objectStore(e).indexNames.contains(i.EventRecordFields.type)&&t.transaction(e).objectStore(e).indexNames.contains(i.EventRecordFields.attr)&&t.transaction(e).objectStore(e).indexNames.contains(i.EventRecordFields.value)&&t.transaction(e).objectStore(e).indexNames.contains(i.EventRecordFields.date)&&t.transaction(e).objectStore(e).indexNames.contains(i.EventRecordFields.surrogateKeyDateField)},destroy:function(){return!0}}},e.prototype.update=function(e,t,n){return"string"==typeof n&&"string"==typeof t?void this.memory.cast([e,t,n],void 0):"string"==typeof t?void this.memory.cast([e,t],void 0):void this.memory.cast([e],void 0)},e.prototype.sync=function(e,t,n){var r=this;return void 0===t&&(t=a.noop),void 0===n&&(n=0),void e.map(function(e){switch(r.syncState.get(e)){case!0:return new Promise(function(t){return void t([e,null])});case!1:return t===a.noop?new Promise(function(t){return void t([e,null])}):new Promise(function(t){return n>0?(void r.get(e),void void setTimeout(function(){return t([e,new Error])})):void 0,void void r.syncWaits.once([e],function(n){return void t([e,n])})});default:return void r.fetch(e),t===a.noop?new Promise(function(t){return void t([e,null])}):new Promise(function(t){return n>0?(void r.get(e),void void setTimeout(function(){return t([e,new Error])})):void 0,void void r.syncWaits.once([e],function(n){return void t([e,n])})})}}).reduce(function(e,t){return e.then(function(e){return t.then(function(t){return e.concat([t])})})},new Promise(function(e){return void e([])})).then(function(e){return void t(e.filter(function(e){return!!e[1]}))})},e.prototype.fetch=function(t){var o=this,s=[];return void this.syncState.set(t,this.syncState.get(t)===!0),void this.cursor(t,i.EventRecordFields.key,r.IDBCursorDirection.prev,r.IDBTransactionMode.readonly,function(r,a){if(a)return void o.syncWaits.emit([t],a);if(!r||r.value.date<o.meta(t).date)return void Array.from(s.reduceRight(function(t,r){return 0===t.length||t[0].type===e.EventType.put?n.concat(t,[r]):t},[]).reduceRight(function(e,t){return e.set(t.attr,t)},new Map).values()).sort(function(e,t){return e.date-t.date||e.id-t.id}).forEach(function(e){void o.memory.register([e.key,e.attr,n.sqid(e.id)],function(){return e})}),void o.syncState.set(t,!0),void o.syncWaits.emit([t],null),void o.update(t),void(s.length>=o.snapshotCycle&&void o.snapshot(t));var c=r.value;if(!(o.memory.refs([c.key,c.attr,n.sqid(c.id)]).length>0)&&(void s.unshift(new i.SavedEventRecord(c.id,c.key,c.value,c.type,c.date)),c.type===e.EventType.put))return void r.continue()})},e.prototype.keys=function(){return this.memory.cast([],void 0).reduce(function(e,t){return 0===e.length||e[e.length-1]!==t.key?n.concat(e,[t.key]):e},[]).sort()},e.prototype.meta=function(e){var t=this.memory.cast([e],void 0);return Object.freeze({key:e,id:t.reduce(function(e,t){return t.id>e?t.id:e},0),date:t.reduce(function(e,t){return t.date>e?t.date:e},0)})},e.prototype.has=function(t){return c(t,this.memory.cast([t],void 0)).type!==e.EventType.delete},e.prototype.get=function(e){return void this.sync([e]),void this.events_.access.emit([e],new v(u.query,o.IdNumber(0),e,"")),c(e,this.memory.cast([e],void 0)).value},e.prototype.add=function(t,s){var a=this;if(void this.events_.access.emit([t.key,t.attr,t.type],new v(t.type,o.IdNumber(0),t.key,t.attr)),!(t instanceof i.UnsavedEventRecord))throw new Error("LocalSocket: Cannot add a saved event: "+JSON.stringify(t));switch(void this.sync([t.key]),t.type){case e.EventType.put:void this.memory.terminate([t.key,t.attr,n.sqid(0)]);break;case e.EventType.delete:case e.EventType.snapshot:void this.memory.refs([t.key]).filter(function(e){var t=e[0],r=t[2];return r===n.sqid(0)}).reduce(function(e,t){var n=t[0],r=n[0],o=n[1],i=n[2];return e.set(r,[r,o,i])},new Map).forEach(function(e){return void a.memory.terminate(e)})}var c=this.memory.register([t.key,t.attr,n.sqid(0),n.sqid()],function(){return t});return void this.update(t.key,t.attr,n.sqid(0)),void new Promise(function(d,u){void setTimeout(u,1e3);var v=function(r){var s=function(){return a.memory.refs([t.key,t.attr,n.sqid(0)]).reduce(function(e,n){var r=n[1];return e||r(void 0)===t},!1)};if(s()){var v=r.objectStore(a.name).add(Object.assign({},t));r.oncomplete=function(){void c();var r=new i.SavedEventRecord(o.IdNumber(v.result),t.key,t.value,t.type,t.date);void a.memory.register([r.key,r.attr,n.sqid(r.id)],function(){return r}),void a.events.save.emit([r.key,r.attr,r.type],new e.Event(r.type,r.id,r.key,r.attr,t.date)),void a.update(r.key,r.attr,n.sqid(r.id)),void d(),a.memory.refs([r.key]).filter(function(e){var t=e[1];return t(void 0)instanceof i.SavedEventRecord}).length>=a.snapshotCycle&&void a.snapshot(r.key)},r.onerror=r.onabort=function(){return s()?void u():void d()}}};s?void v(s):void r.listen(a.database)(function(e){return void v(e.transaction(a.name,r.IDBTransactionMode.readwrite))})}).catch(function(){return void a.events.loss.emit([t.key,t.attr,t.type],new e.Event(t.type,o.IdNumber(0),t.key,t.attr,t.date))})},e.prototype.delete=function(t){return void this.add(new i.UnsavedEventRecord(t,new e.Value,e.EventType.delete))},e.prototype.snapshot=function(t){var n=this;return void r.listen(this.database)(function(o){if(n.syncState.get(t)){var s=o.transaction(n.name,r.IDBTransactionMode.readwrite),a=s.objectStore(n.name),d=a.index(i.EventRecordFields.key).openCursor(t,r.IDBCursorDirection.prev),u=[];d.onsuccess=function(){var r=d.result;if(r){var o=r.value;void u.unshift(new i.SavedEventRecord(o.id,o.key,o.value,o.type,o.date))}if(r&&r.value.type===e.EventType.put)return void r.continue();if(0!==u.length){var a=c(t,u);if(!(a instanceof i.SavedEventRecord)){switch(a.type){case e.EventType.snapshot:return void n.add(new i.UnsavedEventRecord(a.key,a.value,a.type,u.reduce(function(e,t){return t.date>e?t.date:e},0)),s);case e.EventType.delete:return}throw new TypeError("LocalSocket: Invalid event type: "+a.type)}}}}})},e.prototype.clean=function(t,o){var s=this;void 0===t&&(t=1/0);var a=[],c=new Map;return void this.cursor(o?r.IDBKeyRange.bound([o,0],[o,t]):r.IDBKeyRange.upperBound(t),o?i.EventRecordFields.surrogateKeyDateField:i.EventRecordFields.date,r.IDBCursorDirection.prev,r.IDBTransactionMode.readwrite,function(t){if(t){var r=t.value;switch(r.type){case e.EventType.put:void c.set(r.key,c.get(r.key)||!1);break;case e.EventType.snapshot:if(!c.get(r.key))return void c.set(r.key,!0),void void t.continue();break;case e.EventType.delete:void c.set(r.key,!0)}return c.get(r.key)&&(void t.delete(),void a.unshift(r)),void t.continue()}return void a.reduce(function(e,t){return void s.memory.terminate([t.key,t.attr,n.sqid(t.id)])},void 0)})},e.prototype.cursor=function(e,t,n,o,i){var s=this;return void r.listen(this.database)(function(r){var a=r.transaction(s.name,o),c=t?a.objectStore(s.name).index(t).openCursor(e,n):a.objectStore(s.name).openCursor(e,n);c.onsuccess=function(){return c.result&&i(c.result,c.error)},a.oncomplete=function(){return void i(null,a.error)},a.onerror=a.onabort=function(){return void i(null,a.error)}})},e.fields=Object.freeze(i.EventRecordFields),e}();t.EventStore=d;var d;!function(e){e.EventType=s.EventType;var t=function(){function e(e,t,n,r,o){this.type=e,this.id=t,this.key=n,this.attr=r,this.date=o,void Object.freeze(this)}return e}();e.Event=t;var n=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(i.UnsavedEventRecord);e.Record=n;var r=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(s.EventValue);e.Value=r}(d=t.EventStore||(t.EventStore={}));var u={put:"put",delete:"delete",snapshot:"snapshot",query:"query"},v=function(){function e(e,t,n,r){this.type=e,this.id=t,this.key=n,this.attr=r,void Object.freeze(this)}return e}();t.compose=c}),define("src/layer/domain/indexeddb/model/socket/data",["require","exports","src/layer/data/store/event"],function(e,t,n){"use strict";t.STORE_NAME="data";var r=function(e){function r(n){e.call(this,n,t.STORE_NAME),void Object.freeze(this)}return __extends(r,e),r.configure=function(){return n.EventStore.configure(t.STORE_NAME)},r}(n.EventStore);t.DataStore=r;var r;!function(e){e.EventType=n.EventStore.EventType;var t=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(n.EventStore.Event);e.Event=t;var r=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(n.EventStore.Record);e.Record=r;var o=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(n.EventStore.Value);e.Value=o}(r=t.DataStore||(t.DataStore={}))}),define("src/layer/data/store/key-value",["require","exports","spica","src/layer/infrastructure/indexeddb/api","src/lib/noop"],function(e,t,n,r,o){"use strict";var i=function(){function e(e,t,r){if(this.database=e,this.name=t,this.index=r,this.cache=new Map,this.events={access:new n.Observable},"string"!=typeof r)throw new TypeError}return e.configure=function(){return{make:function(){return!0},verify:function(){return!0},destroy:function(){return!0}}},e.prototype.get=function(t,n){var i=this;return void 0===n&&(n=o.noop),void this.events.access.emit([t],[[t],e.EventType.get]),void r.listen(this.database)(function(e){var o,s=e.transaction(i.name,r.IDBTransactionMode.readonly),a=i.index?s.objectStore(i.name).index(i.index).get(t):s.objectStore(i.name).get(t);a.onsuccess=function(){return o=void 0!==a.result&&null!==a.result?a.result:i.cache.get(t)},s.oncomplete=function(){return n(o,s.error)},s.onerror=s.onabort=function(){return n(void 0,s.error)}}),this.cache.get(t)},e.prototype.set=function(e,t,n){return void 0===n&&(n=o.noop),this.put(t,e,n)},e.prototype.put=function(t,n,i){var s=this;return void 0===i&&(i=o.noop),void this.cache.set(n,t),void this.events.access.emit([n],[[n],e.EventType.put]),void r.listen(this.database)(function(e){if(s.cache.has(n)){var t=e.transaction(s.name,r.IDBTransactionMode.readwrite);s.index?t.objectStore(s.name).put(s.cache.get(n)):t.objectStore(s.name).put(s.cache.get(n),n),t.oncomplete=t.onerror=t.onabort=function(){return void i(n,t.error)}}}),this.cache.get(n)},e.prototype.delete=function(t,n){var i=this;void 0===n&&(n=o.noop),void this.cache.delete(t),void this.events.access.emit([t],[[t],e.EventType.delete]),void r.listen(this.database)(function(e){var o=e.transaction(i.name,r.IDBTransactionMode.readwrite);void o.objectStore(i.name).delete(t),o.oncomplete=o.onerror=o.onabort=function(){return void n(o.error)}})},e.prototype.cursor=function(e,t,n,o,i){var s=this;void r.listen(this.database)(function(r){var a=r.transaction(s.name,o),c=t?a.objectStore(s.name).index(t).openCursor(e,n):a.objectStore(s.name).openCursor(e,n);c.onsuccess=function(){return c.result&&i(c.result,c.error)},a.oncomplete=function(){return void i(null,a.error)},a.onerror=a.onabort=function(){return void i(null,a.error)}})},e}();t.KeyValueStore=i;var i;!function(e){e.EventType={get:"get",put:"put",delete:"delete"}}(i=t.KeyValueStore||(t.KeyValueStore={}))}),define("src/layer/domain/indexeddb/model/socket/access",["require","exports","src/layer/data/store/key-value","src/layer/data/store/event"],function(e,t,n,r){"use strict";t.STORE_NAME="access";var o=function(e){function n(o,s){var a=this;e.call(this,o,t.STORE_NAME,n.fields.key),void Object.freeze(this),void s.monitor([],function(e){var t=e.key,n=e.type;return n===r.EventStore.EventType.delete?void a.delete(t):void a.set(t,new i(t,Date.now()))})}return __extends(n,e),n.configure=function(){return{make:function(e){var r=e.objectStoreNames.contains(t.STORE_NAME)?e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME):e.createObjectStore(t.STORE_NAME,{keyPath:n.fields.key,autoIncrement:!1});return r.indexNames.contains(n.fields.key)||void r.createIndex(n.fields.key,n.fields.key,{unique:!0}),r.indexNames.contains(n.fields.date)||void r.createIndex(n.fields.date,n.fields.date),!0},verify:function(e){return e.objectStoreNames.contains(t.STORE_NAME)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(n.fields.key)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(n.fields.date)},destroy:function(){return!0}}},n.fields=Object.freeze({key:"key",date:"date"}),n}(n.KeyValueStore);t.AccessStore=o;var i=function(){function e(e,t){this.key=e,this.date=t}return e}()}),define("src/layer/domain/indexeddb/model/socket/expiry",["require","exports","src/layer/infrastructure/indexeddb/api","src/layer/data/store/key-value","src/layer/data/store/event"],function(e,t,n,r,o){"use strict";t.STORE_NAME="expiry";var i=function(e){function r(i,a,c,d){var u=this;e.call(this,i,t.STORE_NAME,r.fields.key),void Object.freeze(this);var v=0,f=1/0,l=function(e){f<e||(void clearTimeout(v),f=e,v=setTimeout(function(){f=1/0,void u.cursor(null,r.fields.expiry,n.IDBCursorDirection.next,n.IDBTransactionMode.readonly,function(e){if(e){var t=e.value;return t.expiry>Date.now()?void l(t.expiry):(void a.delete(t.key),void e.continue())}})},e-Date.now()),void n.event.once([i,n.IDBEventType.destroy],function(){return void clearTimeout(v)}))};void l(Date.now()),void c.events_.access.monitor([],function(e){var t=e.key,n=e.type;switch(n){case o.EventStore.EventType.delete:return void u.delete(t);default:if(!d.has(t))return;var r=Date.now()+d.get(t);return void u.set(t,new s(t,r)),void l(r)}})}return __extends(r,e),r.configure=function(){return{make:function(e){var n=e.objectStoreNames.contains(t.STORE_NAME)?e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME):e.createObjectStore(t.STORE_NAME,{keyPath:r.fields.key,autoIncrement:!1});return n.indexNames.contains(r.fields.key)||void n.createIndex(r.fields.key,r.fields.key,{unique:!0}),n.indexNames.contains(r.fields.expiry)||void n.createIndex(r.fields.expiry,r.fields.expiry),!0},verify:function(e){return e.objectStoreNames.contains(t.STORE_NAME)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(r.fields.key)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(r.fields.expiry)},destroy:function(){return!0}}},r.fields=Object.freeze({key:"key",expiry:"expiry"}),r}(r.KeyValueStore);t.ExpiryStore=i;var s=function(){function e(e,t){this.key=e,this.expiry=t}return e}()}),define("src/layer/domain/indexeddb/model/socket",["require","exports","spica","src/layer/infrastructure/indexeddb/api","src/layer/domain/indexeddb/model/socket/data","src/layer/domain/indexeddb/model/socket/access","src/layer/domain/indexeddb/model/socket/expiry","src/lib/noop"],function(e,t,n,r,o,i,s,a){"use strict";var c=function(){function e(e,t,a){var c=this;void 0===a&&(a=1/0),this.database=e,this.expiry=a,this.uuid=n.uuid(),this.events={load:new n.Observable,save:new n.Observable,loss:new n.Observable},this.expiries=new Map,void r.open(e,{make:function(e){return o.DataStore.configure().make(e)&&i.AccessStore.configure().make(e)&&s.ExpiryStore.configure().make(e);
},verify:function(e){return o.DataStore.configure().verify(e)&&i.AccessStore.configure().verify(e)&&s.ExpiryStore.configure().verify(e)},destroy:function(e,n){return o.DataStore.configure().destroy(e,n)&&i.AccessStore.configure().destroy(e,n)&&s.ExpiryStore.configure().destroy(e,n)&&t(e,n)}}),this.schema=new d(this,this.expiries),void r.event.on([e,r.IDBEventType.destroy,this.uuid],function(){return void c.schema.bind()})}return e.prototype.sync=function(e,t,n){return void 0===t&&(t=a.noop),this.schema.data.sync(e,t,n)},e.prototype.meta=function(e){return this.schema.data.meta(e)},e.prototype.has=function(e){return this.schema.data.has(e)},e.prototype.get=function(e){return this.schema.data.get(e)},e.prototype.add=function(e){return this.schema.data.add(e)},e.prototype.delete=function(e){return this.schema.data.delete(e)},e.prototype.expire=function(e,t){if(void 0===t&&(t=this.expiry),t!==1/0)return void this.expiries.set(e,t)},e.prototype.recent=function(e,t){void 0===t&&(t=function(){});var n=[];return void this.schema.access.cursor(null,i.AccessStore.fields.date,r.IDBCursorDirection.prevunique,r.IDBTransactionMode.readonly,function(r,o){return r?void(--e<0||(void n.push(r.primaryKey),void r.continue())):void t(n,o)})},e.prototype.close=function(){return void r.close(this.database)},e.prototype.destroy=function(){return void r.event.off([this.database,r.IDBEventType.destroy,this.uuid]),void r.destroy(this.database)},e}();t.SocketStore=c;var c;!function(e){e.EventType=o.DataStore.EventType;var t=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(o.DataStore.Event);e.Event=t;var n=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(o.DataStore.Record);e.Record=n;var r=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(o.DataStore.Value);e.Value=r}(c=t.SocketStore||(t.SocketStore={}));var d=function(){function e(e,t){this.store_=e,this.expiries_=t,void this.bind()}return e.prototype.bind=function(){var e=this,t=this.data?this.data.keys():[];this.data=new o.DataStore(this.store_.database),this.data.events.load.monitor([],function(t){return e.store_.events.load.emit([t.key,t.attr,t.type],t)}),this.data.events.save.monitor([],function(t){return e.store_.events.save.emit([t.key,t.attr,t.type],t)}),this.data.events.loss.monitor([],function(t){return e.store_.events.loss.emit([t.key,t.attr,t.type],t)}),this.access=new i.AccessStore(this.store_.database,this.data.events_.access),this.expire=new s.ExpiryStore(this.store_.database,this.store_,this.data,this.expiries_),void this.data.sync(t)},e}()}),define("src/layer/infrastructure/webstorage/module/global",["require","exports","spica"],function(e,t,n){"use strict";t.supportWebStorage=function(){try{var e="localsocket#"+n.uuid();if(void self.sessionStorage.setItem(e,e),e!==self.sessionStorage.getItem(e))throw 1;return void self.sessionStorage.removeItem(e),!0}catch(e){return!1}}(),t.localStorage=t.supportWebStorage?self.localStorage:void 0,t.sessionStorage=t.supportWebStorage?self.sessionStorage:void 0}),define("src/layer/infrastructure/webstorage/model/event",["require","exports","spica","src/layer/infrastructure/webstorage/module/global"],function(e,t,n,r){"use strict";var o={localStorage:new n.Observable,sessionStorage:new n.Observable};t.events=o,void window.addEventListener("storage",function(e){switch(e.storageArea){case r.localStorage:return void o.localStorage.emit(["storage"],e);case r.sessionStorage:return void o.sessionStorage.emit(["storage"],e);default:return}})}),define("src/layer/infrastructure/webstorage/api",["require","exports","src/layer/infrastructure/webstorage/module/global","src/layer/infrastructure/webstorage/model/event"],function(e,t,n,r){"use strict";t.localStorage=n.localStorage,t.sessionStorage=n.sessionStorage,t.supportWebStorage=n.supportWebStorage,t.events=r.events}),define("src/layer/domain/webstorage/service/event",["require","exports","spica","src/layer/infrastructure/webstorage/api"],function(e,t,n,r){"use strict";function o(e){var t=new n.Observable;return void e.on(["storage"],function(e){return void t.emit([e.key],e)}),t}t.events={localStorage:o(r.events.localStorage),sessionStorage:o(r.events.sessionStorage)}}),define("src/layer/domain/webstorage/service/storage",["require","exports"],function(e,t){"use strict";var n=function(){function e(){this.store=new Map}return Object.defineProperty(e.prototype,"length",{get:function(){return this.store.size},enumerable:!0,configurable:!0}),e.prototype.getItem=function(e){return this.store.has(e)?this.store.get(e):null},e.prototype.setItem=function(e,t){void this.store.set(e,t)},e.prototype.removeItem=function(e){void this.store.delete(e)},e.prototype.clear=function(){void this.store.clear()},e}();t.fakeStorage=new n}),define("src/layer/domain/webstorage/repository/port",["require","exports","spica","src/layer/domain/dao/api","src/layer/domain/webstorage/service/event","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/service/storage"],function(e,t,n,r,o,i,s){"use strict";function a(e,t,n,r){return void 0===t&&(t=i.sessionStorage||s.fakeStorage),void 0===r&&(r={update:function(e){},delete:function(e){}}),new f(e,t,n,r)}var c,d=new Map,u=new Map;!function(e){e.send="send",e.recv="recv"}(c=t.PortEventType||(t.PortEventType={}));var v=function(){function e(e,t,n,r,o){this.type=e,this.key=t,this.attr=n,this.newValue=r,this.oldValue=o,void Object.freeze(this)}return e}();t.PortEvent=v,t.port=a;var f=function(){function e(e,t,r,s){void 0===s&&(s={update:function(e){},delete:function(e){}}),this.name=e,this.storage=t,this.factory=r,this.log=s,this.cache=this.storage===i.localStorage?d:u,this.eventSource=this.storage===i.localStorage?o.events.localStorage:o.events.sessionStorage,this.uuid=n.uuid(),this.events={send:new n.Observable,recv:new n.Observable},void Object.freeze(this)}return e.prototype.link=function(){function e(e){try{return JSON.parse(e||"{}")||{}}catch(e){return{}}}var t=this;if(this.cache.has(this.name))return this.cache.get(this.name);var o=Object.assign((a={},a[r.SCHEMA.KEY.NAME]=this.name,a[r.SCHEMA.EVENT.NAME]=new n.Observable,a),e(this.storage.getItem(this.name))),i=r.build(o,this.factory,function(e,n,i){void t.log.update(t.name),void t.storage.setItem(t.name,JSON.stringify(Object.keys(o).filter(r.isValidPropertyName).filter(r.isValidPropertyValue(o)).reduce(function(e,t){return e[t]=o[t],e},{})));var s=new v(c.send,t.name,e,n,i);void o.__event.emit([s.type,s.attr],s),void t.events.send.emit([s.attr],s)}),s=function(n){var i=n.newValue,s=e(i);void Object.keys(s).filter(r.isValidPropertyName).filter(r.isValidPropertyValue(s)).reduce(function(e,n){var r=o[n],i=s[n];if(i!==r){o[n]=i;var a=new v(c.recv,t.name,n,i,r);void o.__event.emit([a.type,a.attr],a),void t.events.recv.emit([a.attr],a)}},void 0)};return void this.eventSource.on([this.name,this.uuid],s),void this.cache.set(this.name,i),void this.log.update(this.name),i;var a},e.prototype.destroy=function(){void this.eventSource.off([this.name,this.uuid]),void this.cache.delete(this.name),void this.storage.removeItem(this.name),void this.log.delete(this.name)},e}()}),define("src/layer/domain/webstorage/api",["require","exports","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/service/event","src/layer/domain/webstorage/repository/port"],function(e,t,n,r,o){"use strict";t.localStorage=n.localStorage,t.sessionStorage=n.sessionStorage,t.supportWebStorage=n.supportWebStorage,t.events=r.events,t.webstorage=o.port,t.WebStorageEvent=o.PortEvent,t.WebStorageEventType=o.PortEventType}),define("src/layer/domain/indexeddb/repository/socket",["require","exports","spica","src/layer/domain/dao/api","src/layer/domain/indexeddb/model/socket","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/api"],function(e,t,n,r,o,i,s){"use strict";function a(e,t,n,r){return void 0===n&&(n=function(){return!0}),void 0===r&&(r=1/0),new u(e,t,r,n)}t.socket=a;var c=function(){function e(e,t,n){this.key=e,this.attr=t,this.date=n,void Object.freeze(this)}return e}(),d=function(){function e(){this.msgs=[],this.msgLatestUpdates_=new Map}return e.prototype.recv=function(){var e=this;return this.msgs.filter(function(t){var n=t.date<=e.msgLatestUpdates_.get(t.key);return void e.msgLatestUpdates_.set(t.key,t.date),!n}).map(function(e){return e.key})},e.prototype.send=function(e){this.msgs=n.concat([e],this.msgs.slice(0,9))},e}(),u=function(e){function t(t,n,a,u){var v=this;e.call(this,t,u,a),this.factory=n,this.proxy=s.webstorage(this.database,i.localStorage,function(){return new d}),this.port=this.proxy.link(),this.links=new Map,this.sources=new Map,void this.port.__event.on([s.WebStorageEventType.recv,"msgs"],function(){return void v.port.recv().reduce(function(e,t){return void v.schema.data.fetch(t)},void 0)}),void this.events.save.monitor([],function(e){var t=e.key,n=e.attr;return void v.port.send(new c(t,n,Date.now()))}),void this.events.load.monitor([],function(e){var t=e.key,n=e.attr,i=e.type,a=v.sources.get(t);if(a)switch(i){case o.SocketStore.EventType.put:var c=a[n],d=v.get(t)[n];return a[n]=d,void void a.__event.emit([s.WebStorageEventType.recv,n],new s.WebStorageEvent(s.WebStorageEventType.recv,t,n,d,c));case o.SocketStore.EventType.delete:var u=v.get(t);return void void Object.keys(u).filter(r.isValidPropertyName).filter(r.isValidPropertyValue(u)).sort().reduce(function(e,n){var r=a[n],o=void 0;a[n]=o,void a.__event.emit([s.WebStorageEventType.recv,n],new s.WebStorageEvent(s.WebStorageEventType.recv,t,n,o,r))},void 0);case o.SocketStore.EventType.snapshot:var f=v.get(t);return void void Object.keys(f).filter(r.isValidPropertyName).filter(r.isValidPropertyValue(f)).sort().reduce(function(e,n){var r=a[n],o=f[n];a[n]=o,void a.__event.emit([s.WebStorageEventType.recv,n],new s.WebStorageEvent(s.WebStorageEventType.recv,t,n,o,r))},void 0)}}),void Object.freeze(this)}return __extends(t,e),t.prototype.link=function(e,t){var i=this;return void this.expire(e,t),this.links.has(e)?this.links.get(e):this.links.set(e,r.build(Object.defineProperties((void this.sources.set(e,n.clone({},this.get(e))),this.sources.get(e)),{__meta:{get:function(){return i.meta(e)}},__id:{get:function(){return this.__meta.id}},__key:{get:function(){return this.__meta.key}},__date:{get:function(){return this.__meta.date}},__event:{value:new n.Observable}}),this.factory,function(t,n,r){return void i.add(new o.SocketStore.Record(e,(a={},a[t]=n,a))),void i.sources.get(e).__event.emit([s.WebStorageEventType.send,t],new s.WebStorageEvent(s.WebStorageEventType.send,e,t,n,r));var a})).get(e)},t.prototype.destroy=function(){void this.proxy.destroy(),void e.prototype.destroy.call(this)},t}(o.SocketStore)}),define("src/layer/domain/indexeddb/service/event",["require","exports","src/layer/infrastructure/indexeddb/api"],function(e,t,n){"use strict";t.event=n.event,t.IDBEventType=n.IDBEventType}),define("src/layer/domain/indexeddb/api",["require","exports","src/layer/domain/indexeddb/repository/socket","src/layer/domain/indexeddb/service/event"],function(e,t,n,r){"use strict";t.socket=n.socket,t.event=r.event,t.IDBEventType=r.IDBEventType}),define("src/layer/application/api",["require","exports","src/layer/domain/indexeddb/api","src/layer/domain/webstorage/api","src/layer/domain/indexeddb/api","src/layer/domain/webstorage/api","src/layer/domain/webstorage/api"],function(e,t,n,r,o,i,s){"use strict";function a(e,t){function r(e){var t=function(){function e(e,t,n){void 0===t&&(t=1/0),void 0===n&&(n=function(){return!0}),this.schema=e,this.expiry=t,this.destroy=n,void Object.freeze(this)}return e}();return new t(e.schema,e.expiry,e.destroy)}return t=r(t),n.socket(e,t.schema,t.destroy,t.expiry)}function c(e,t){function n(e){var t=function(){function e(e,t){void 0===t&&(t=function(){return!0}),this.schema=e,this.destroy=t,void Object.freeze(this)}return e}();return new t(e.schema,e.destroy)}return t=n(t),r.webstorage(e,r.localStorage,t.schema)}t.status=s.supportWebStorage,t.socket=a,t.port=c;var d;!function(e){e.indexedDB=o.event,e.localStorage=i.events.localStorage,e.sessionStorage=i.events.sessionStorage}(d=t.events||(t.events={}))}),define("src/layer/interface/api",["require","exports","src/layer/application/api"],function(e,t,n){"use strict";t.socket=n.socket,t.port=n.port,t.events=n.events,t.status=n.status}),define("src/export",["require","exports","src/layer/interface/api"],function(e,t,n){"use strict";t.default=n.socket,t.socket=n.socket,t.port=n.port,t.status=n.status}),define("localsocket",["require","exports","src/export","src/export","./index","./src/import"],function(e,t,n,r){"use strict";function o(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}o(n),t.default=r.default});