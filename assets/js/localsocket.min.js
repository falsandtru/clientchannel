/*! localsocket v0.1.1 https://github.com/falsandtru/localsocket | (c) 2015, falsandtru | MIT License (https://opensource.org/licenses/MIT) */
define="function"==typeof define&&define.amd?define:function(){"use strict";var e="localsocket",t={};return function r(n,o,i){return i?void i.apply(this,o.map(function(e){switch(e){case"require":return"function"==typeof require?require:void 0;case"exports":return-1===n.indexOf("/")?t[n]="undefined"==typeof exports?self[n]=self[n]||{}:exports:t[n]=t.hasOwnProperty(n)?t[n]:{};default:return".d"===e.slice(-2)&&{}||t.hasOwnProperty(e)&&t[e]||"function"==typeof require&&require(e)||self[e]}})):void r(e,n,o)}}();var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define("src/layer/data/constraint/values",["require","exports"],function(e,t){"use strict";function r(e){return e.length>0&&"_"!==e[0]&&"_"!==e[e.length-1]&&!i.test(e)&&o.test(e)}function n(e){return function(t){switch(typeof e[t]){case"undefined":case"boolean":case"number":case"string":case"object":return!0;default:return!1}}}var o=/^[A-z][0-9A-z_]*$/,i=/^[0-9A-Z_]+$/;t.isValidName=r,t.isValidValue=n}),define("src/lib/noop",["require","exports"],function(e,t){"use strict";function r(){}t.noop=r}),define("src/layer/domain/dao/module/builder",["require","exports","arch-stream","src/layer/data/constraint/values","src/lib/noop"],function(e,t,r,n,o){"use strict";function i(e,i,a){void 0===a&&(a=o.noop);var s=i();if(void Object.keys(t.SCHEMA).map(function(e){return t.SCHEMA[e].NAME}).reduce(function(e,t){delete s[t]},void 0),"string"!=typeof e[t.SCHEMA.KEY.NAME])throw new TypeError("LocalSocket: Invalid key: "+e[t.SCHEMA.KEY.NAME]);var c=r.assign(Object.keys(s).filter(n.isValidName).filter(n.isValidValue(s)).reduce(function(t,r){var o=Object.getOwnPropertyDescriptor(s,r);if(o&&(o.get||o.set))return t;var i=s[r];return void 0===e[r]&&(e[r]=i),t[r]={enumerable:!0,get:function(){return void 0===e[r]?i:e[r]},set:function(t){var o=e[r];n.isValidValue(e)(r)&&(t===o&&t instanceof Object==!1||(e[r]=void 0===t?i:t,void a(r,t,o)))}},t},{}),(d={},d[t.SCHEMA.META.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.META.NAME]}},d[t.SCHEMA.ID.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.ID.NAME]}},d[t.SCHEMA.KEY.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.KEY.NAME]}},d[t.SCHEMA.DATE.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.DATE.NAME]}},d[t.SCHEMA.EVENT.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.EVENT.NAME]}},d));return void Object.defineProperties(s,c),void Object.seal(s),s;var d}t.isValidPropertyName=n.isValidName,t.isValidPropertyValue=n.isValidValue,t.SCHEMA={META:{NAME:"__meta"},ID:{NAME:"__id"},KEY:{NAME:"__key"},DATE:{NAME:"__date"},EVENT:{NAME:"__event"}},t.build=i}),define("src/layer/domain/dao/api",["require","exports","src/layer/domain/dao/module/builder"],function(e,t,r){"use strict";t.SCHEMA=r.SCHEMA,t.build=r.build,t.isValidPropertyName=r.isValidPropertyName,t.isValidPropertyValue=r.isValidPropertyValue}),define("src/layer/infrastructure/indexeddb/module/global",["require","exports"],function(e,t){"use strict";t.indexedDB=self.indexedDB||self.webkitIndexedDB||self.mozIndexedDB||self.msIndexedDB;var r=self.IDBKeyRange||self.webkitIDBKeyRange||self.mozIDBKeyRange||self.msIDBKeyRange;t.IDBKeyRange=r;var n;!function(e){e.readonly="readonly",e.readwrite="readwrite"}(n=t.IDBTransaction||(t.IDBTransaction={}));var o;!function(e){e.next="next",e.nextunique="nextunique",e.prev="prev",e.prevunique="prevunique"}(o=t.IDBCursorDirection||(t.IDBCursorDirection={}))}),define("src/layer/infrastructure/indexeddb/model/event",["require","exports"],function(e,t){"use strict";var r;!function(e){e.connect="connect",e.disconnect="disconnect",e.block="block",e.error="error",e.abort="abort",e.crash="crash",e.destroy="destroy"}(r=t.IDBEventType||(t.IDBEventType={}));var n=function(){function e(e,t){this.type=e,this.name=t,this.namespace=[this.name],void Object.freeze(this)}return e}();t.IDBEvent=n}),define("src/layer/infrastructure/webstorage/module/global",["require","exports","arch-stream"],function(e,t,r){"use strict";t.supportWebStorage=function(){try{var e="localsocket#"+r.uuid();if(void self.sessionStorage.setItem(e,e),e!==self.sessionStorage.getItem(e))throw 1;return void self.sessionStorage.removeItem(e),!0}catch(t){return!1}}(),t.localStorage=t.supportWebStorage?self.localStorage:void 0,t.sessionStorage=t.supportWebStorage?self.sessionStorage:void 0}),define("src/layer/infrastructure/webstorage/model/event",["require","exports","arch-stream","src/layer/infrastructure/webstorage/module/global"],function(e,t,r,n){"use strict";var o={localStorage:new r.Observable,sessionStorage:new r.Observable};t.events=o,void window.addEventListener("storage",function(e){switch(e.storageArea){case n.localStorage:return void o.localStorage.emit(["storage"],e);case n.sessionStorage:return void o.sessionStorage.emit(["storage"],e)}})}),define("src/layer/infrastructure/webstorage/api",["require","exports","src/layer/infrastructure/webstorage/module/global","src/layer/infrastructure/webstorage/model/event"],function(e,t,r,n){"use strict";t.localStorage=r.localStorage,t.sessionStorage=r.sessionStorage,t.supportWebStorage=r.supportWebStorage,t.events=n.events}),define("src/layer/infrastructure/indexeddb/model/access",["require","exports","arch-stream","src/layer/infrastructure/indexeddb/module/global","src/layer/infrastructure/indexeddb/model/event"],function(e,t,r,n,o){"use strict";function i(e,r){void f.set(e,0),void t.ConfigMap.set(e,r),l.has(e)||void d(new y.Initial(e))}function a(e){return function(t){var r=p.get(e)||p.add(e,[]);void r.push(t);var n=l.get(e);n instanceof y.Success&&void n.drain()}}function s(e){return void f.set(e,1),void t.ConfigMap.set(e,{make:function(){return!1},verify:function(){return!1},destroy:function(){return!1}}),l.get(e)instanceof y.Success?l.get(e).end():void(l.has(e)||void d(new y.Initial(e)))}function c(e){return void f.set(e,2),void t.ConfigMap.set(e,{make:function(){return!1},verify:function(){return!1},destroy:function(){return!0}}),l.get(e)instanceof y.Success?l.get(e).destroy():void(l.has(e)||void d(new y.Initial(e)))}function d(e,r){function i(e){var t=e.database;void u.emit([t,o.IDBEventType.block],new o.IDBEvent(o.IDBEventType.block,t))}function a(e){var r=e.database,n=e.session,o=n.transaction.db,i=t.ConfigMap.get(r),a=i.make,d=i.destroy;try{a(o)?(n.onsuccess=function(e){return void s(new y.Success(r,o))},n.onerror=function(e){return void c(new y.Error(r,n.error,e))}):n.onsuccess=n.onerror=function(e){void o.close(),d(n.error,e)?void E(new y.Destroy(r)):void b(new y.End(r))}}catch(u){void h(new y.Crash(r,u))}}function s(e){var r=e.database,n=e.connection,i=function(){n.onversionchange=function(){return void n.close()},n.onerror=void 0,n.onabort=void 0,n.onclose=void 0};switch(n.onversionchange=function(t){var a=t.newVersion;void i(),void n.close(),a||(void p["delete"](r),void u.emit([r,o.IDBEventType.destroy],new o.IDBEvent(o.IDBEventType.destroy,r))),l.get(r)===e&&void b(new y.End(r))},n.onerror=function(e){void i(),void c(new y.Error(r,e.target.error,e))},n.onabort=function(e){void i(),void v(new y.Abort(r,e.target.error,e))},n.onclose=function(t){void i(),void u.emit([r,o.IDBEventType.destroy],new o.IDBEvent(o.IDBEventType.destroy,r)),l.get(r)===e&&void b(new y.End(r))},e.destroy=function(){void i(),void n.close(),void E(new y.Destroy(r))},e.end=function(){void i(),void n.close(),void b(new y.End(r))},e.drain=function(){var e=p.get(r)||[];try{for(;e.length>0&&0===f.get(r);)void e[0](n),void e.shift()}catch(t){t instanceof DOMError||t instanceof DOMException?void console.warn(t):void console.error(t),void i(),void h(new y.Crash(r,t))}},f.get(r)){case 0:var a=t.ConfigMap.get(r).verify;try{if(!a(n))return void b(new y.End(r),n.version+1)}catch(s){return void h(new y.Crash(r,s))}return void u.emit([r,o.IDBEventType.connect],new o.IDBEvent(o.IDBEventType.connect,r)),void e.drain();case 1:return void e.end();case 2:return void e.destroy()}throw new TypeError("LocalSocket: Invalid command "+f.get(r)+".")}function c(e){var r=e.database,n=e.error,i=e.event;void i.preventDefault(),void u.emit([r,o.IDBEventType.error],new o.IDBEvent(o.IDBEventType.error,r));var a=t.ConfigMap.get(r).destroy;return a(n,i)?void E(new y.Destroy(r)):void b(new y.End(r))}function v(e){var r=e.database,n=e.error,i=e.event;void i.preventDefault(),void u.emit([r,o.IDBEventType.abort],new o.IDBEvent(o.IDBEventType.abort,r));var a=t.ConfigMap.get(r).destroy;return a(n,i)?void E(new y.Destroy(r)):void b(new y.End(r))}function h(e){var r=e.database,n=e.error;void u.emit([r,o.IDBEventType.crash],new o.IDBEvent(o.IDBEventType.crash,r));var i=t.ConfigMap.get(r).destroy;return i(n,null)?void E(new y.Destroy(r)):void b(new y.End(r))}function E(e){var t=e.database,r=n.indexedDB.deleteDatabase(t);r.onsuccess=function(e){void p["delete"](t),void u.emit([t,o.IDBEventType.destroy],new o.IDBEvent(o.IDBEventType.destroy,t)),void b(new y.End(t))},r.onerror=function(e){void c(new y.Error(t,r.error,e))}}function b(e,r){var n=e.database;switch(void 0===r&&(r=0),void l["delete"](n),f.get(n)){case 0:return void d(new y.Initial(n),r);case 1:return void f["delete"](n),void t.ConfigMap["delete"](n),void u.emit([n,o.IDBEventType.disconnect],new o.IDBEvent(o.IDBEventType.disconnect,n));case 2:return void f["delete"](n),void t.ConfigMap["delete"](n),void u.emit([n,o.IDBEventType.disconnect],new o.IDBEvent(o.IDBEventType.disconnect,n))}throw new TypeError("LocalSocket: Invalid command "+f.get(n)+".")}var g=e.database;void 0===r&&(r=0);t.ConfigMap.get(g);try{var m=r?n.indexedDB.open(g,r):n.indexedDB.open(g),S=function(){m.onupgradeneeded=void 0,m.onsuccess=void 0,m.onerror=void 0};m.onblocked=function(e){return void i(new y.Block(g))},m.onupgradeneeded=function(e){void S(),void a(new y.Upgrade(g,m))},m.onsuccess=function(e){void S(),void s(new y.Success(g,m.result))},m.onerror=function(e){void S(),void c(new y.Error(g,m.error,e))}}catch(w){void h(new y.Crash(g,w))}}var u=new r.Observable;t.event=u,t.ConfigMap=new r.Map;var v,f=new r.Map;!function(e){e[e.open=0]="open",e[e.close=1]="close",e[e.destroy=2]="destroy"}(v||(v={}));var y,l=new r.Set(function(e,t){switch(e.constructor){case y.Initial:switch(t.constructor){case y.Block:case y.Upgrade:case y.Success:case y.Error:case y.Abort:case y.Crash:return t}break;case y.Block:switch(t.constructor){case y.Upgrade:case y.Success:case y.Error:case y.Abort:return t}break;case y.Upgrade:switch(t.constructor){case y.Success:case y.Error:case y.Abort:case y.Crash:case y.Destroy:case y.End:return t}break;case y.Success:switch(t.constructor){case y.Error:case y.Abort:case y.Crash:case y.Destroy:case y.End:return t}break;case y.Error:switch(t.constructor){case y.Destroy:case y.End:return t}break;case y.Abort:switch(t.constructor){case y.Destroy:case y.End:return t}break;case y.Crash:switch(t.constructor){case y.Destroy:case y.End:return t}break;case y.Destroy:switch(t.constructor){case y.Error:case y.End:return t}}throw new Error("LocalSocket: Invalid mutation: "+e.constructor.toString().match(/\w+/g)[1]+" to "+t.constructor.toString().match(/\w+/g)[1])});!function(e){var t=function(){function e(e){this.database=e,void l.add(e,this)}return e}();e.Initial=t;var r=function(){function e(e){this.database=e,void l.add(e,this)}return e}();e.Block=r;var n=function(){function e(e,t){this.database=e,this.session=t,void l.add(e,this)}return e}();e.Upgrade=n;var o=function(){function e(e,t){this.database=e,this.connection=t,void l.add(e,this)}return e}();e.Success=o;var i=function(){function e(e,t,r){this.database=e,this.error=t,this.event=r,void l.add(e,this)}return e}();e.Error=i;var a=function(){function e(e,t,r){this.database=e,this.error=t,this.event=r,void l.add(e,this)}return e}();e.Abort=a;var s=function(){function e(e,t){this.database=e,this.error=t,void l.add(e,this)}return e}();e.Crash=s;var c=function(){function e(e){this.database=e,void l.add(e,this)}return e}();e.Destroy=c;var d=function(){function e(e){this.database=e,void l.add(e,this)}return e}();e.End=d}(y||(y={}));var p=new r.Set;t.open=i,t.listen=a,t.close=s,t.destroy=c}),define("src/layer/infrastructure/indexeddb/api",["require","exports","src/layer/infrastructure/indexeddb/module/global","src/layer/infrastructure/indexeddb/model/access","src/layer/infrastructure/indexeddb/model/event"],function(e,t,r,n,o){"use strict";t.indexedDB=r.indexedDB,t.IDBKeyRange=r.IDBKeyRange,t.IDBTransaction=r.IDBTransaction,t.IDBCursorDirection=r.IDBCursorDirection,t.open=n.open,t.listen=n.listen,t.close=n.close,t.destroy=n.destroy,t.event=n.event,t.IDBEvent=o.IDBEvent,t.IDBEventType=o.IDBEventType}),define("src/layer/data/constraint/types",["require","exports"],function(e,t){"use strict";function r(e){return+e}function n(e){return void 0!==e&&null!==e?e+"":""}t.IdNumber=r,t.KeyString=n}),define("src/layer/data/lib/assign",["require","exports"],function(e,t){"use strict";function r(e){function t(e){function t(e){return e instanceof Object&&e.constructor instanceof Object&&e.constructor.BYTES_PER_ELEMENT>0&&o(e.buffer)}function r(e){return"Blob"===i(e)}function n(e){return"ImageData"===i(e)}function o(e){return"ArrayBuffer"===i(e)}function i(t){return Object.prototype.toString.call(e).split(" ").pop().slice(0,-1)}return!(!e||"object"!=typeof e||t(e)||r(e)||n(e)||o(e))}for(var n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];if(void 0===e||null===e)throw new TypeError("LocalSocket: assign: Cannot merge objects into "+e+".");for(var i=Object(e),a=0;a<n.length;a++){var s=n[a];if(void 0!==s&&null!==s){s=Object(s);for(var c=0,d=Object.keys(Object(s));c<d.length;c++){var u=d[c],v=Object.getOwnPropertyDescriptor(s,u);if(void 0!==v&&v.enumerable){var f=s[u];i[u];t(f)?i[u]=Array.isArray(f)?f.slice():r({},f):i[u]=f}}}}return i}t.assign=r}),define("src/layer/data/schema/event",["require","exports","src/layer/data/lib/assign"],function(e,t,r){"use strict";t.EventType={put:"put","delete":"delete",snapshot:"snapshot"};var n=function(){function e(){}return e}();t.EventValue=n;var o=function(){function e(e,o,i,a,s){if("number"==typeof this.id&&this.id>0==!1||void 0!==this.id)throw new TypeError("LocalSocket: EventRecord: Invalid event id: "+this.id);if(this.type=s,"string"!=typeof this.type)throw new TypeError("LocalSocket: EventRecord: Invalid event type: "+this.type);if(this.key=o,"string"!=typeof this.key)throw new TypeError("LocalSocket: EventRecord: Invalid event key: "+this.key);if(this.value=i,"object"!=typeof this.value||!this.value)throw new TypeError("LocalSocket: EventRecord: Invalid event value: "+this.value);if(this.date=a,"number"!=typeof this.date||this.date>=0==!1)throw new TypeError("LocalSocket: EventRecord: Invalid event date: "+this.date);if(this.attr=this.type===t.EventType.put?Object.keys(i).reduce(function(e,t){return t.length>0&&"_"!==t[0]&&"_"!==t[t.length-1]?t:e},""):"","string"!=typeof this.attr)throw new TypeError("LocalSocket: EventRecord: Invalid event attr: "+this.key);if(this.type===t.EventType.put&&0===this.attr.length)throw new TypeError("LocalSocket: EventRecord: Invalid event attr with "+this.type+": "+this.attr);if(this.type!==t.EventType.put&&0!==this.attr.length)throw new TypeError("LocalSocket: EventRecord: Invalid event attr with "+this.type+": "+this.attr);switch(s){case t.EventType.put:return this.value=i=r.assign(new n,(c={},c[this.attr]=i[this.attr],c)),void void Object.freeze(this.value);case t.EventType.snapshot:return this.value=i=r.assign(new n,i),void void Object.freeze(this.value);case t.EventType["delete"]:default:return this.value=i=new n,void void Object.freeze(this.value)}throw new TypeError("LocalSocket: Invalid event type: "+s);var c}return e}();t.EventRecord=o}),define("src/layer/data/store/event",["require","exports","arch-stream","src/layer/infrastructure/indexeddb/api","src/layer/data/constraint/types","src/layer/data/schema/event","src/layer/data/lib/assign","src/lib/noop"],function(e,t,r,n,o,i,a,s){"use strict";function c(e){function t(e){return e.map(function(e,t){return[e,t]}).sort(function(e,t){var r=e[0],n=e[1],o=t[0],i=t[1];return indexedDB.cmp(r.key,o.key)||o.date-r.date||i-n}).reduceRight(function(e,t){var n=e[0],o=e.slice(1),i=t[0],a=n[0];return a?a.key===i.key?r.concat([r.concat([i],n)],o):r.concat([[i]],r.concat([n],o)):[[i]]},[[]])}function n(e,t){switch(t.type){case i.EventType.put:return void 0!==t.value[t.attr]?new d(t.key,a.assign(new i.EventValue,e.value,t.value),i.EventType.snapshot):new d(t.key,Object.keys(e.value).reduce(function(r,n){return n===t.attr?r:(r[n]=e[n],r)},new i.EventValue),i.EventType.snapshot);case i.EventType.snapshot:return t;case i.EventType["delete"]:return t}throw new TypeError("LocalSocket: Invalid event type: "+t.type)}return t(e).map(function(e){return e.reduceRight(n,new d(o.KeyString(""),new i.EventValue,i.EventType["delete"],0))})}t.EventType=i.EventType,t.EventValue=i.EventValue;var d=function(e){function t(t,r,n,o){if(void 0===n&&(n=i.EventType.put),void 0===o&&(o=Date.now()),e.call(this,void 0,t,r,o,n),void 0!==this.id||"id"in this)throw new TypeError("LocalSocket: UnsavedEventRecord: Invalid event id: "+this.id)}return __extends(t,e),t}(i.EventRecord);t.UnsavedEventRecord=d;var u=function(e){function t(t,r,n,o,i){if(e.call(this,t,r,n,i,o),this.id=t,this.id>0==!1)throw new TypeError("LocalSocket: SavedEventRecord: Invalid event id: "+this.id);void Object.freeze(this)}return __extends(t,e),t}(i.EventRecord);t.SavedEventRecord=u,t.ESEventType={put:"put","delete":"delete",snapshot:"snapshot",query:"query"};var v=function(){function e(e,t,r,n){this.type=e,this.id=t,this.key=r,this.attr=n,void Object.freeze(this)}return e}();t.ESEvent=v;var f={id:"id",key:"key",type:"type",attr:"attr",value:"value",date:"date",surrogateKeyDateField:"key+date"},y=function(){function e(e,t){var n=this;this.database=e,this.name=t,this.cache=new(function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(r.Supervisor)),this.events={load:new r.Observable,save:new r.Observable,loss:new r.Observable,access:new r.Observable},this.syncState=new r.Map,this.syncWaits=new r.Observable,this.snapshotCycle=10,this.snapshotJobState=new r.Map;var o=new r.Set(function(e,t){return t>e?t:e}),i=new r.Set(function(e,t){return t>e?t:e});void this.cache.events.exec.monitor([],function(e){var t=(e[0],e[1]),r=t(void 0);if(r instanceof u==!1)return void i.add(r.key,r.date);var a=function(){return!o.has(r.key)||r.id>o.get(r.key)},s=function(){return!i.has(r.key)||r.date>i.get(r.key)&&r.date>n.cache.cast([r.key],void 0).filter(function(e){return e!==r}).reduce(function(e,t){return t.date>e?t.date:e},0)};a()&&s()?(void o.add(r.key,r.id),void i.add(r.key,r.date),void n.events.load.emit([r.key,r.attr,r.type],new v(r.type,r.id,r.key,r.attr))):(void o.add(r.key,r.id),void i.add(r.key,r.date))})}return e.configure=function(e){return{make:function(t){var r=t.objectStoreNames.contains(e)?t.transaction(e).objectStore(e):t.createObjectStore(e,{keyPath:f.id,autoIncrement:!0});return r.indexNames.contains(f.id)||void r.createIndex(f.id,f.id,{unique:!0}),r.indexNames.contains(f.key)||void r.createIndex(f.key,f.key),r.indexNames.contains(f.type)||void r.createIndex(f.type,f.type),r.indexNames.contains(f.attr)||void r.createIndex(f.attr,f.attr),r.indexNames.contains(f.value)||void r.createIndex(f.value,f.value),r.indexNames.contains(f.date)||void r.createIndex(f.date,f.date),r.indexNames.contains(f.surrogateKeyDateField)||void r.createIndex(f.surrogateKeyDateField,[f.key,f.date]),!0},verify:function(t){return t.objectStoreNames.contains(e)&&t.transaction(e).objectStore(e).indexNames.contains(f.id)&&t.transaction(e).objectStore(e).indexNames.contains(f.key)&&t.transaction(e).objectStore(e).indexNames.contains(f.type)&&t.transaction(e).objectStore(e).indexNames.contains(f.attr)&&t.transaction(e).objectStore(e).indexNames.contains(f.value)&&t.transaction(e).objectStore(e).indexNames.contains(f.date)&&t.transaction(e).objectStore(e).indexNames.contains(f.surrogateKeyDateField)},destroy:function(){return!0}}},e.prototype.sync=function(e,t){var n=this;return void 0===t&&(t=s.noop),void e.reduce(function(e,o){switch(n.syncState.get(o)){case!0:return e.then(function(e){return r.concat(e,[void 0])});case!1:if(t===s.noop)return e.then(function(e){return r.concat(e,[void 0])});var i=r.Msg();return void n.syncWaits.once([o],function(e){return void i.send([e])}),e.then(function(e){return i.then(function(t){return r.concat(e,t)})});default:if(void n.update(o),t===s.noop)return e.then(function(e){return r.concat(e,[void 0])});var a=r.Msg();return void n.syncWaits.once([o],function(e){return void a.send([e])}),e.then(function(e){return a.then(function(t){return r.concat(e,t)})})}},r.Msg().send([],!0)).then(t)},e.prototype.update=function(e){var t=this,o=this.meta(e),a=[];return void this.syncState.set(e,this.syncState.get(e)===!0),void this.cursor(e,f.key,n.IDBCursorDirection.prev,n.IDBTransaction.readonly,function(n,s){if(s)return void t.syncWaits.emit([e],s);if(!n||n.value.id<=o.id)return c(a).reduce(function(e){return e}).type===i.EventType["delete"]?void t.clean(1/0,e):(void a.reduceRight(function(e,t){return e.some(function(e){var r=e.attr;return r===t.attr})?e:r.concat([t],e)},[]).reduce(function(e,t){switch(t.type){case i.EventType.put:return r.concat([t],e);default:return[t]}},[]).reduce(function(e,n){void t.cache.terminate([n.key,n.attr,r.sqid(n.id)]),void t.cache.register([n.key,n.attr,r.sqid(n.id)],function(e){return n})},void 0),void t.cache.cast([e],void 0)),void t.syncState.set(e,!0),void t.syncWaits.emit([e],void 0),void(a.length>t.snapshotCycle&&void t.snapshot(e));var d=n.value;t.cache.refs([d.key,d.attr,r.sqid(d.id)]).length>0||(void a.unshift(new u(d.id,d.key,d.value,d.type,d.date)),d.type===i.EventType.put&&void n["continue"]())})},e.prototype.meta=function(e){var t=this.cache.cast([e],void 0);return Object.freeze(a.assign({id:t.reduce(function(e,t){return t.id>e?t.id:e},0),date:0},c(t).reduce(function(e){return e}),{key:e}))},e.prototype.keys=function(){return this.cache.cast([],void 0).reduce(function(e,t){return 0===e.length||e[e.length-1]!==t.key?r.concat(e,[t.key]):e},[]).sort()},e.prototype.has=function(e){return c(this.cache.cast([e],void 0)).reduce(function(e){return e}).type!==i.EventType["delete"]},e.prototype.get=function(e){return void this.sync([e]),void this.events.access.emit([e],new v(t.ESEventType.query,o.IdNumber(0),e,"")),c(this.cache.cast([e],void 0)).reduce(function(e){return e}).value},e.prototype.add=function(e){var t=this;if(void this.events.access.emit([e.key,e.attr,e.type],new v(e.type,o.IdNumber(0),e.key,e.attr)),e instanceof d==!1)throw new Error("LocalSocket: Cannot add a saved event: "+JSON.stringify(e));void this.sync([e.key]);var a=r.sqid();return void this.cache.register([e.key,e.attr,r.sqid(0),a],function(t){return e}),void this.cache.cast([e.key,e.attr,r.sqid(0),a],void 0),void n.listen(this.database)(function(s){if(0!==t.cache.refs([e.key,e.attr,r.sqid(0)]).length){var c=s.transaction(t.name,n.IDBTransaction.readwrite),d=c.objectStore(t.name).add(e);c.oncomplete=function(n){var s=new u(o.IdNumber(d.result),e.key,e.value,e.type,e.date);void t.cache.terminate([s.key,s.attr,r.sqid(0),a]),void t.cache.register([s.key,s.attr,r.sqid(s.id)],function(e){return s}),void t.events.save.emit([s.key,s.attr,s.type],new v(s.type,s.id,s.key,s.attr)),void t.cache.cast([s.key,s.attr,r.sqid(s.id)],void 0),t.cache.refs([e.key]).filter(function(e){var t=e[1];return t(void 0)instanceof u}).length>t.snapshotCycle?void t.snapshot(e.key):s.type===i.EventType["delete"]&&void t.clean(1/0,s.key)},c.onerror=c.onabort=function(n){void setTimeout(function(){0!==t.cache.refs([e.key,e.attr,r.sqid(0),a]).length&&void t.events.loss.emit([e.key,e.attr,e.type],new v(e.type,e.id,e.key,e.attr))},1e3)}}})},e.prototype["delete"]=function(e){return void this.add(new d(e,new i.EventValue,i.EventType["delete"]))},e.prototype.snapshot=function(e){var t=this;if(!this.snapshotJobState.get(e))return void this.snapshotJobState.set(e,!0),void n.listen(this.database)(function(r){var o=r.transaction(t.name,n.IDBTransaction.readwrite),a=o.objectStore(t.name),s=a.index(f.key).openCursor(e,n.IDBCursorDirection.prev),v=[];s.onsuccess=function(r){var n=s.result;if(n){var o=n.value;void v.unshift(new u(o.id,o.key,o.value,o.type,o.date))}if(!n||n.value.type!==i.EventType.put){if(v.length<t.snapshotCycle)return;void t.clean(1/0,e);var f=c(v).reduce(function(e){return e});if(f instanceof u)return;switch(f.type){case i.EventType.snapshot:return void a.add(new d(f.key,f.value,f.type,v.reduce(function(e,t){return t.date>e?t.date:e},0)));case i.EventType["delete"]:return}throw new TypeError("LocalSocket: Invalid event type: "+f.type)}void n["continue"]()},o.oncomplete=function(r){void t.snapshotJobState.set(e,!1),void t.update(e)},o.onerror=o.onabort=function(r){void t.snapshotJobState.set(e,!1)}})},e.prototype.clean=function(e,t){var o=this;void 0===e&&(e=1/0);var a=[],s=new r.Map;return void this.cursor(t?n.IDBKeyRange.bound([t,0],[t,e]):n.IDBKeyRange.upperBound(e),t?f.surrogateKeyDateField:f.date,n.IDBCursorDirection.prev,n.IDBTransaction.readwrite,function(e,t){if(!e)return void a.reduce(function(e,t){return void o.cache.terminate([t.key,t.attr,r.sqid(t.id)])},void 0);var n=e.value;switch(n.type){case i.EventType.put:void s.set(n.key,s.get(n.key)||!1);break;case i.EventType.snapshot:if(!s.get(n.key))return void s.set(n.key,!0),void void e["continue"]();break;case i.EventType["delete"]:void s.set(n.key,!0);break;default:void s.set(n.key,!0)}s.get(n.key)&&(void e["delete"](),void a.unshift(n)),void e["continue"]()})},e.prototype.cursor=function(e,t,r,o,i){var a=this;return void n.listen(this.database)(function(n){var s=n.transaction(a.name,o),c=t?s.objectStore(a.name).index(t).openCursor(e,r):s.objectStore(a.name).openCursor(e,r);c.onsuccess=function(e){return c.result&&i(c.result,c.error)},s.oncomplete=function(e){return void i(null,s.error)},s.onerror=s.onabort=function(e){return void i(null,s.error)}})},e}();t.AbstractEventStore=y,t.compose=c}),define("src/layer/domain/indexeddb/model/socket/data",["require","exports","src/layer/data/store/event"],function(e,t,r){"use strict";t.STORE_NAME="data",t.STORE_FIELDS={key:"key"};var n=function(){function e(){}return e}();t.DataValue=n;var o=function(e){function n(r){e.call(this,r,t.STORE_NAME),void Object.freeze(this)}return __extends(n,e),n.configure=function(){return r.AbstractEventStore.configure(t.STORE_NAME)},n}(r.AbstractEventStore);t.DataStore=o}),define("src/layer/data/store/key-value",["require","exports","arch-stream","src/layer/infrastructure/indexeddb/api","src/lib/noop"],function(e,t,r,n,o){"use strict";t.EventType={get:"get",put:"put","delete":"delete"};var i=function(){function e(e,t,n){if(this.database=e,this.name=t,this.index=n,this.cache=new r.Map,this.events={access:new r.Observable},"string"!=typeof n)throw new TypeError}return e.configure=function(){return{make:function(){return!0},verify:function(){return!0},destroy:function(){return!0}}},e.prototype.get=function(e,r){var i=this;return void 0===r&&(r=o.noop),void this.events.access.emit([e],[[e],t.EventType.get]),void n.listen(this.database)(function(t){var o,a=t.transaction(i.name,n.IDBTransaction.readonly),s=i.index?a.objectStore(i.name).index(i.index).get(e):a.objectStore(i.name).get(e);s.onsuccess=function(t){return o=void 0!==s.result&&null!==s.result?s.result:i.cache.get(e)},a.oncomplete=function(e){return r(o,a.error)},a.onerror=a.onabort=function(e){return r(void 0,a.error)}}),this.cache.get(e)},e.prototype.set=function(e,t,r){return void 0===r&&(r=o.noop),this.put(t,e,r)},e.prototype.put=function(e,r,i){var a=this;return void 0===i&&(i=o.noop),void this.cache.set(r,e),void this.events.access.emit([r],[[r],t.EventType.put]),void n.listen(this.database)(function(e){if(a.cache.has(r)){var t=e.transaction(a.name,n.IDBTransaction.readwrite);a.index?t.objectStore(a.name).put(a.cache.get(r)):t.objectStore(a.name).put(a.cache.get(r),r);t.oncomplete=t.onerror=t.onabort=function(e){return void i(r,t.error)}}}),this.cache.get(r)},e.prototype["delete"]=function(e,r){var i=this;void 0===r&&(r=o.noop),void this.cache["delete"](e),void this.events.access.emit([e],[[e],t.EventType["delete"]]),void n.listen(this.database)(function(t){var o=t.transaction(i.name,n.IDBTransaction.readwrite);o.objectStore(i.name)["delete"](e);o.oncomplete=o.onerror=o.onabort=function(e){return void r(o.error)}})},e.prototype.cursor=function(e,t,r,o,i){var a=this;void n.listen(this.database)(function(n){var s=n.transaction(a.name,o),c=t?s.objectStore(a.name).index(t).openCursor(e,r):s.objectStore(a.name).openCursor(e,r);c.onsuccess=function(e){return c.result&&i(c.result,c.error)},s.oncomplete=function(e){return void i(null,s.error)},s.onerror=s.onabort=function(e){return void i(null,s.error)}})},e}();t.AbstractKeyValueStore=i}),define("src/layer/domain/indexeddb/model/socket/access",["require","exports","src/layer/data/store/key-value","src/layer/data/store/event"],function(e,t,r,n){"use strict";t.STORE_NAME="access",t.STORE_FIELDS={key:"key",date:"date"};var o=function(){function e(e,t){this.key=e,this.date=t}return e}(),i=function(e){function r(r,i){var a=this;e.call(this,r,t.STORE_NAME,t.STORE_FIELDS.key),void Object.freeze(this),void i.monitor([],function(e){var t=e.key,r=e.type;return r===n.ESEventType["delete"]?void a["delete"](t):void a.set(t,new o(t,Date.now()))})}return __extends(r,e),r.configure=function(){return{make:function(e){var r=e.objectStoreNames.contains(t.STORE_NAME)?e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME):e.createObjectStore(t.STORE_NAME,{keyPath:t.STORE_FIELDS.key,autoIncrement:!1});return r.indexNames.contains(t.STORE_FIELDS.key)||void r.createIndex(t.STORE_FIELDS.key,t.STORE_FIELDS.key,{unique:!0}),r.indexNames.contains(t.STORE_FIELDS.date)||void r.createIndex(t.STORE_FIELDS.date,t.STORE_FIELDS.date),!0},verify:function(e){return e.objectStoreNames.contains(t.STORE_NAME)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(t.STORE_FIELDS.key)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(t.STORE_FIELDS.date)},destroy:function(){return!0}}},r}(r.AbstractKeyValueStore);t.AccessStore=i}),define("src/layer/domain/indexeddb/model/socket/expiry",["require","exports","src/layer/infrastructure/indexeddb/api","src/layer/data/store/key-value","src/layer/data/store/event"],function(e,t,r,n,o){"use strict";t.STORE_NAME="expiry",t.STORE_FIELDS={key:"key",expiry:"expiry"};var i=function(){function e(e,t){this.key=e,this.expiry=t}return e}(),a=function(e){function n(n,a,s,c){var d=this;e.call(this,n,t.STORE_NAME,t.STORE_FIELDS.key),void Object.freeze(this);var u=0,v=1/0,f=function(e){e>v||(void clearTimeout(u),v=e,u=setTimeout(function(){v=1/0,void d.cursor(null,t.STORE_FIELDS.expiry,r.IDBCursorDirection.next,r.IDBTransaction.readonly,function(e){if(e){var t=e.value;t.expiry>Date.now()?void f(t.expiry):(void a["delete"](t.key),void e["continue"]())}})},e-Date.now()),void r.event.once([n,r.IDBEventType.destroy],function(){return void clearTimeout(u)}))};void f(Date.now()),void s.events.access.monitor([],function(e){var t=e.key,r=e.type;if(r===o.ESEventType["delete"])void d["delete"](t);else{if(!c.has(t))return;var n=Date.now()+c.get(t);void d.set(t,new i(t,n)),void f(n)}})}return __extends(n,e),n.configure=function(){return{make:function(e){var r=e.objectStoreNames.contains(t.STORE_NAME)?e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME):e.createObjectStore(t.STORE_NAME,{keyPath:t.STORE_FIELDS.key,autoIncrement:!1});return r.indexNames.contains(t.STORE_FIELDS.key)||void r.createIndex(t.STORE_FIELDS.key,t.STORE_FIELDS.key,{unique:!0}),r.indexNames.contains(t.STORE_FIELDS.expiry)||void r.createIndex(t.STORE_FIELDS.expiry,t.STORE_FIELDS.expiry),!0},verify:function(e){
return e.objectStoreNames.contains(t.STORE_NAME)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(t.STORE_FIELDS.key)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(t.STORE_FIELDS.expiry)},destroy:function(){return!0}}},n}(n.AbstractKeyValueStore);t.ExpiryStore=a}),define("src/layer/domain/indexeddb/model/socket",["require","exports","arch-stream","src/layer/infrastructure/indexeddb/api","src/layer/data/constraint/types","src/layer/data/store/event","src/layer/domain/indexeddb/model/socket/data","src/layer/domain/indexeddb/model/socket/access","src/layer/domain/indexeddb/model/socket/expiry","src/lib/noop"],function(e,t,r,n,o,i,a,s,c,d){"use strict";t.SocketRecord=i.UnsavedEventRecord,t.ESEventType=i.ESEventType,t.SocketValue=a.DataValue;var u=function(){function e(e,t,o){var i=this;void 0===o&&(o=1/0),this.database=e,this.expiry=o,this.uuid=r.uuid(),this.events={load:new r.Observable,save:new r.Observable,loss:new r.Observable},this.expiries=new r.Map,void n.open(e,{make:function(e){return a.DataStore.configure().make(e)&&s.AccessStore.configure().make(e)&&c.ExpiryStore.configure().make(e)},verify:function(e){return a.DataStore.configure().verify(e)&&s.AccessStore.configure().verify(e)&&c.ExpiryStore.configure().verify(e)},destroy:function(e,r){return a.DataStore.configure().destroy(e,r)&&s.AccessStore.configure().destroy(e,r)&&c.ExpiryStore.configure().destroy(e,r)&&t(e,r)}}),this.schema=new v(this,this.expiries),void n.event.on([e,n.IDBEventType.destroy,this.uuid],function(){return void i.schema.bind()})}return e.prototype.sync=function(e,t){return void 0===t&&(t=d.noop),this.schema.data.sync(e,t)},e.prototype.meta=function(e){return this.schema.data.meta(o.KeyString(e))},e.prototype.has=function(e){return this.schema.data.has(o.KeyString(e))},e.prototype.get=function(e){return this.schema.data.get(o.KeyString(e))},e.prototype.add=function(e){return this.schema.data.add(e)},e.prototype["delete"]=function(e){return this.schema.data["delete"](o.KeyString(e))},e.prototype.expire=function(e,t){return void 0===t&&(t=this.expiry),t!==1/0?void this.expiries.set(e,t):void 0},e.prototype.recent=function(e,t){var r=[];return void this.schema.access.cursor(null,s.STORE_FIELDS.date,n.IDBCursorDirection.prevunique,n.IDBTransaction.readonly,function(n,o){return n?void(--e<0||(void r.push(n.primaryKey),void n["continue"]())):void t(r,o)})},e.prototype.destroy=function(){return void n.event.off([this.database,n.IDBEventType.destroy,this.uuid]),n.destroy(this.database)},e}();t.SocketStore=u;var v=function(){function e(e,t){this.store_=e,this.expiries_=t,void this.bind()}return e.prototype.bind=function(){var e=this,t=this.data?this.data.keys():[];this.data=new a.DataStore(this.store_.database),this.data.events.load.monitor([],function(t){return e.store_.events.load.emit([t.key,t.attr,t.type],t)}),this.data.events.save.monitor([],function(t){return e.store_.events.save.emit([t.key,t.attr,t.type],t)}),this.data.events.loss.monitor([],function(t){return e.store_.events.loss.emit([t.key,t.attr,t.type],t)}),this.access=new s.AccessStore(this.store_.database,this.data.events.access),this.expire=new c.ExpiryStore(this.store_.database,this.store_,this.data,this.expiries_),void this.data.sync(t)},e}()}),define("src/layer/domain/webstorage/service/event",["require","exports","arch-stream","src/layer/infrastructure/webstorage/api"],function(e,t,r,n){"use strict";function o(e){var t=new r.Observable;return void e.on(["storage"],function(e){return void t.emit([e.key],e)}),t}t.events={localStorage:o(n.events.localStorage),sessionStorage:o(n.events.sessionStorage)}}),define("src/layer/domain/webstorage/service/storage",["require","exports","arch-stream"],function(e,t,r){"use strict";var n=function(){function e(){this.store=new r.Map}return Object.defineProperty(e.prototype,"length",{get:function(){return this.store.size},enumerable:!0,configurable:!0}),e.prototype.getItem=function(e){return this.store.has(e)?this.store.get(e):null},e.prototype.setItem=function(e,t){void this.store.set(e,t)},e.prototype.removeItem=function(e){void this.store["delete"](e)},e.prototype.clear=function(){void this.store.clear()},e}();t.fakeStorage=new n}),define("src/layer/domain/webstorage/repository/port",["require","exports","arch-stream","src/layer/domain/dao/api","src/layer/domain/webstorage/service/event","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/service/storage"],function(e,t,r,n,o,i,a){"use strict";function s(e,t,r,n){return void 0===t&&(t=i.sessionStorage||a.fakeStorage),void 0===n&&(n={update:function(e){},"delete":function(e){}}),new f(e,t,r,n)}var c,d=new r.Set,u=(new r.Set,new r.Set);new r.Set;!function(e){e.send="send",e.recv="recv"}(c=t.PortEventType||(t.PortEventType={}));var v=function(){function e(e,t,r,n,o){this.type=e,this.key=t,this.attr=r,this.newValue=n,this.oldValue=o}return e}();t.PortEvent=v,t.repository=s;var f=function(){function e(e,t,n,a){void 0===a&&(a={update:function(e){},"delete":function(e){}}),this.name=e,this.storage=t,this.factory=n,this.log=a,this.cache=this.storage===i.localStorage?d:u,this.eventSource=this.storage===i.localStorage?o.events.localStorage:o.events.sessionStorage,this.uuid=r.uuid(),this.events={send:new r.Observable,recv:new r.Observable},void Object.freeze(this)}return e.prototype.link=function(){function e(e){try{return JSON.parse(e)||{}}catch(t){return{}}}var t=this;if(this.cache.has(this.name))return this.cache.get(this.name);var o=r.assign((s={},s[n.SCHEMA.KEY.NAME]=this.name,s[n.SCHEMA.EVENT.NAME]=new r.Observable,s),e(this.storage.getItem(this.name))),i=n.build(o,this.factory,function(e,r,i){void t.log.update(t.name),void t.storage.setItem(t.name,JSON.stringify(Object.keys(o).filter(n.isValidPropertyName).filter(n.isValidPropertyValue(o)).reduce(function(e,t){return e[t]=o[t],e},{})));var a=new v(c.send,t.name,e,r,i);void o.__event.emit([a.type,a.attr],a),void t.events.send.emit([a.attr],a)}),a=function(r){var i=r.newValue,a=e(i);void Object.keys(a).filter(n.isValidPropertyName).filter(n.isValidPropertyValue(a)).reduce(function(e,r){var n=o[r],i=a[r];if(i!==n){o[r]=i;var s=new v(c.recv,t.name,r,i,n);void o.__event.emit([s.type,s.attr],s),void t.events.recv.emit([s.attr],s)}},void 0)};return void this.eventSource.on([this.name,this.uuid],a),void this.cache.add(this.name,i),void this.log.update(this.name),i;var s},e.prototype.destroy=function(){void this.eventSource.off([this.name,this.uuid]),void this.cache["delete"](this.name),void this.storage.removeItem(this.name),void this.log["delete"](this.name)},e}()}),define("src/layer/domain/webstorage/api",["require","exports","src/layer/domain/webstorage/repository/port","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/service/event","src/layer/domain/webstorage/repository/port"],function(e,t,r,n,o,i){"use strict";function a(e,t,n){return r.repository(e,t,n)}t.localStorage=n.localStorage,t.sessionStorage=n.sessionStorage,t.supportWebStorage=n.supportWebStorage,t.events=o.events,t.WebStorageEvent=i.PortEvent,t.WebStorageEventType=i.PortEventType,t.webstorage=a}),define("src/layer/domain/indexeddb/repository/socket",["require","exports","arch-stream","src/layer/domain/dao/api","src/layer/domain/indexeddb/model/socket","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/api","src/layer/data/constraint/types","src/layer/data/lib/assign"],function(e,t,r,n,o,i,a,s,c){"use strict";function d(e,t,r,n){return void 0===n&&(n=1/0),new f(e,t,n,r)}t.socket=d;var u=function(){function e(e,t,r){this.key=e,this.attr=t,this.date=r}return e}(),v=function(){function e(){this.msgs=[],this.msgHeadSet_=new r.Set(function(e,t){return t>e?t:e})}return e.prototype.recv=function(){var e=this;return this.msgs.map(function(e){return new u(e.key,e.attr,e.date)}).filter(function(t){return!e.msgHeadSet_.has(t.key)||t.date>e.msgHeadSet_.get(t.key)}).filter(function(t){return!void e.msgHeadSet_.add(t.key,t.date)})},e.prototype.send=function(e){this.msgs=r.concat([e],this.msgs.slice(0,9))},e}(),f=function(e){function t(t,s,c,d){var f=this;e.call(this,t,d,c),this.factory=s,this.proxy=a.webstorage(this.database,i.localStorage,function(){return new v}),this.port=this.proxy.link(),this.links=new r.Set,this.sources=new r.Set,void this.port.__event.on([a.WebStorageEventType.recv,"msgs"],function(){void f.port.recv().reduce(function(e,t){return void f.schema.data.update(t.key)},void 0)}),void this.events.save.monitor([],function(e){var t=(e.id,e.key),r=e.attr;void f.port.send(new u(t,r,Date.now()))}),void this.events.load.monitor([],function(e){var t=(e.id,e.key),r=e.attr,i=e.type,s=f.sources.get(t);if(s)switch(i){case o.ESEventType.put:var c=s[r],d=f.get(t)[r];return s[r]=d,void void s.__event.emit([a.WebStorageEventType.recv,r],new a.WebStorageEvent(a.WebStorageEventType.recv,t,r,d,c));case o.ESEventType["delete"]:var u=f.get(t);return void void Object.keys(u).filter(n.isValidPropertyName).filter(n.isValidPropertyValue(u)).sort().reduce(function(e,r){var n=s[r],o=void 0;s[r]=o,void s.__event.emit([a.WebStorageEventType.recv,r],new a.WebStorageEvent(a.WebStorageEventType.recv,t,r,o,n))},void 0);case o.ESEventType.snapshot:var v=f.get(t);return void void Object.keys(v).filter(n.isValidPropertyName).filter(n.isValidPropertyValue(v)).sort().reduce(function(e,r){var n=s[r],o=v[r];s[r]=o,void s.__event.emit([a.WebStorageEventType.recv,r],new a.WebStorageEvent(a.WebStorageEventType.recv,t,r,o,n))},void 0)}}),void Object.freeze(this)}return __extends(t,e),t.prototype.link=function(e,t){var i=this;return void this.expire(e,t),this.links.has(e)?this.links.get(e):this.links.add(e,n.build(Object.defineProperties(this.sources.add(e,c.assign({},this.get(e))),{__meta:{get:function(){return i.meta(e)}},__id:{get:function(){return this.__meta.id}},__key:{get:function(){return this.__meta.key}},__date:{get:function(){return this.__meta.date}},__event:{value:new r.Observable}}),this.factory,function(t,r,n){void i.add(new o.SocketRecord(s.KeyString(e),(c={},c[t]=r,c))),void i.sources.get(e).__event.emit([a.WebStorageEventType.send,t],new a.WebStorageEvent(a.WebStorageEventType.send,e,t,r,n));var c}))},t.prototype.destroy=function(){void this.proxy.destroy(),void e.prototype.destroy.call(this)},t}(o.SocketStore)}),define("src/layer/domain/indexeddb/service/event",["require","exports","src/layer/infrastructure/indexeddb/api"],function(e,t,r){"use strict";t.event=r.event,t.IDBEventType=r.IDBEventType}),define("src/layer/domain/indexeddb/api",["require","exports","src/layer/domain/indexeddb/repository/socket","src/layer/domain/indexeddb/service/event"],function(e,t,r,n){"use strict";t.socket=r.socket,t.event=n.event,t.IDBEventType=n.IDBEventType}),define("src/layer/app/api",["require","exports","src/layer/domain/indexeddb/api","src/layer/domain/webstorage/api","src/layer/domain/indexeddb/api","src/layer/domain/webstorage/api","src/layer/domain/webstorage/api"],function(e,t,r,n,o,i,a){"use strict";function s(e,t){function n(e){var t=function(){function e(e,t,r){void 0===t&&(t=1/0),void 0===r&&(r=function(){return!0}),this.schema=e,this.expiry=t,this.destroy=r,void Object.freeze(this)}return e}();return new t(e.schema,e.expiry,e.destroy)}return t=n(t),r.socket(e,t.schema,t.destroy,t.expiry)}function c(e,t){function r(e){var t=function(){function e(e,t){void 0===t&&(t=function(){return!0}),this.schema=e,this.destroy=t,void Object.freeze(this)}return e}();return new t(e.schema,e.destroy)}return t=r(t),n.webstorage(e,n.localStorage,t.schema)}t.status=a.supportWebStorage,t.socket=s,t.port=c;var d;!function(e){e.indexedDB=o.event,e.localStorage=i.events.localStorage,e.sessionStorage=i.events.sessionStorage}(d=t.events||(t.events={}))}),define("src/layer/interface/api",["require","exports","src/layer/app/api"],function(e,t,r){"use strict";t.socket=r.socket,t.port=r.port,t.events=r.events,t.status=r.status}),define("src/export",["require","exports","src/layer/interface/api"],function(e,t,r){"use strict";t["default"]=r.socket,t.socket=r.socket,t.port=r.port,t.status=r.status}),define("localsocket",["require","exports","src/export","src/export"],function(e,t,r,n){"use strict";function o(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}o(r),t["default"]=n["default"]});