/*! localsocket v0.0.2 https://github.com/falsandtru/localsocket | (c) 2015, falsandtru | MIT (https://opensource.org/licenses/MIT) */
define="function"==typeof define&&define.amd?define:function(){"use strict";var e="localsocket",t={};return function r(n,i,o){return o?void o.apply(this,i.map(function(e){switch(e){case"require":return"function"==typeof require?require:void 0;case"exports":return-1===n.indexOf("/")?t[n]="undefined"==typeof exports?self[n]=self[n]||{}:exports:t[n]=t.hasOwnProperty(n)?t[n]:{};default:return".d"===e.slice(-2)&&{}||t.hasOwnProperty(e)&&t[e]||"function"==typeof require&&require(e)||self[e]}})):void r(e,n,i)}}();var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define("src/layer/infrastructure/indexeddb/module/global",["require","exports"],function(e,t){"use strict";t.indexedDB=self.indexedDB||self.webkitIndexedDB||self.mozIndexedDB||self.msIndexedDB;var r=self.IDBKeyRange||self.webkitIDBKeyRange||self.mozIDBKeyRange||self.msIDBKeyRange;t.IDBKeyRange=r;var n;!function(e){e.readonly="readonly",e.readwrite="readwrite"}(n=t.IDBTransaction||(t.IDBTransaction={}));var i;!function(e){e.next="next",e.nextunique="nextunique",e.prev="prev",e.prevunique="prevunique"}(i=t.IDBCursorDirection||(t.IDBCursorDirection={}))}),define("src/layer/infrastructure/indexeddb/model/event",["require","exports"],function(e,t){"use strict";!function(e){e[e.connect=0]="connect",e[e.disconnect=1]="disconnect",e[e.block=2]="block",e[e.error=3]="error",e[e.abort=4]="abort",e[e.crash=5]="crash",e[e.destroy=6]="destroy"}(t.IDBEvenType||(t.IDBEvenType={}));var r,n=t.IDBEvenType;!function(e){e.connect=n[n.connect],e.disconnect=n[n.disconnect],e.block=n[n.block],e.error=n[n.error],e.abort=n[n.abort],e.crash=n[n.crash],e.destroy=n[n.destroy]}(r=t.IDBEventName||(t.IDBEventName={}));var i=function(){function e(e,t){this.name=t,this.namespace=[this.name],this.type=n[e],void Object.freeze(this)}return e}();t.IDBEvent=i}),define("src/layer/infrastructure/indexeddb/model/access",["require","exports","arch-stream","src/layer/infrastructure/indexeddb/module/global","src/layer/infrastructure/indexeddb/model/event"],function(e,t,r,n,i){"use strict";function o(e,r){return void E.set(e,0),void t.ConfigMap.set(e,r),k.get(e)||(void k.add(e,!0),void u(e)),function(t){var r=x.get(e)||x.add(e,[]);void r.push(t),void d(e)}}function a(e){return function(t){var r=x.get(e)||x.add(e,[]);void r.push(t),void d(e)}}function s(e){return void E.set(e,1),void t.ConfigMap.set(e,{make:function(){return!1},verify:function(){return!1},destroy:function(){return!1}}),w.get(e)?w.get(e).end():void(k.get(e)||(void k.add(e,!0),void u(e)))}function c(e){return void E.set(e,2),void t.ConfigMap.set(e,{make:function(){return!1},verify:function(){return!1},destroy:function(){return!0}}),w.get(e)?w.get(e).destroy():void(k.get(e)||(void k.add(e,!0),void u(e)))}function d(e){for(var t=w.get(e),r=x.get(e)||[];;)try{for(;t&&r.length>0&&0===E.get(e);)void r[0](t),void r.shift();break}catch(n){void console.error(n,n+"",n.stack),void h(e,n)}}function u(e,r){void 0===r&&(r=0);t.ConfigMap.get(e);try{var i=r?n.indexedDB.open(e,r):n.indexedDB.open(e);i.onupgradeneeded=function(t){return void f(e,i)},i.onsuccess=function(t){return void l(e,i.result)},i.onblocked=function(t){return void v(e,i)},i.onerror=function(t){return void y(e,i.error,t)}}catch(o){void h(e,o)}}function v(e,t){void S.emit(new i.IDBEvent(i.IDBEvenType.block,e))}function f(e,r){var n=r.result,i=t.ConfigMap.get(e),o=i.make,a=i.destroy;try{o(n)?(r.onsuccess=function(t){return void l(e,n)},r.onerror=function(t){return void y(e,r.error,t)}):r.onsuccess=r.onerror=function(t){void n.close(),a(r.error,t)?void m(e):void g(e)}}catch(s){void h(e,s)}}function l(e,r){switch(r.onversionchange=function(e){return void r.close()},r.end=function(){void w["delete"](e),void r.close(),void g(e)},r.destroy=function(){void w["delete"](e),void r.close(),void m(e)},r.onerror=function(t){void w["delete"](e),void y(e,t.target.error,t)},r.onabort=function(t){void w["delete"](e),void p(e,t.target.error,t)},E.get(e)){case 0:var n=t.ConfigMap.get(e).verify;try{if(!n(r))return void g(e,+r.version+1);void S.emit(new i.IDBEvent(i.IDBEvenType.connect,e)),void w.add(e,r),void d(e)}catch(o){void h(e,o)}return;case 1:return void r.end();case 2:return void r.destroy()}throw new TypeError("LocalSocket: Invalid command "+E.get(e)+".")}function y(e,r,n){void n.preventDefault(),void w["delete"](e),void S.emit(new i.IDBEvent(i.IDBEvenType.error,e));var o=t.ConfigMap.get(e).destroy;return o(r,n)?void m(e):void g(e)}function p(e,r,n){void n.preventDefault(),void w["delete"](e),void S.emit(new i.IDBEvent(i.IDBEvenType.abort,e));var o=t.ConfigMap.get(e).destroy;return o(r,n)?void m(e):void g(e)}function h(e,r){void w["delete"](e),void S.emit(new i.IDBEvent(i.IDBEvenType.crash,e));var n=t.ConfigMap.get(e).destroy;return n(r,null)?void m(e):void g(e)}function m(e){void w["delete"](e);var t=n.indexedDB.deleteDatabase(e);t.onsuccess=function(t){return void x["delete"](e),void S.emit(new i.IDBEvent(i.IDBEvenType.destroy,e)),void g(e)},t.onerror=function(r){void y(e,t.error,r)}}function g(e,r){switch(void 0===r&&(r=0),void w["delete"](e),void S.emit(new i.IDBEvent(i.IDBEvenType.disconnect,e)),E.get(e)){case 0:return void u(e,r);case 1:return void t.ConfigMap["delete"](e),void void k["delete"](e);case 2:return void t.ConfigMap["delete"](e),void void k["delete"](e)}throw new TypeError("LocalSocket: Invalid command "+E.get(e)+".")}var S=new r.Observable;t.event=S,t.ConfigMap=new r.Map;var b;!function(e){e[e.open=0]="open",e[e.close=1]="close",e[e.destroy=2]="destroy"}(b||(b={}));var E=new r.Map,x=new r.Set,k=new r.Set,w=new r.Set;t.open=o,t.listen=a,t.close=s,t.destroy=c}),define("src/layer/infrastructure/indexeddb/api",["require","exports","src/layer/infrastructure/indexeddb/module/global","src/layer/infrastructure/indexeddb/model/access","src/layer/infrastructure/indexeddb/model/event"],function(e,t,r,n,i){"use strict";t.indexedDB=r.indexedDB,t.IDBKeyRange=r.IDBKeyRange,t.IDBTransaction=r.IDBTransaction,t.IDBCursorDirection=r.IDBCursorDirection,t.open=n.open,t.listen=n.listen,t.close=n.close,t.destroy=n.destroy,t.event=n.event,t.IDBEvent=i.IDBEvent,t.IDBEventName=i.IDBEventName}),define("src/lib/noop",["require","exports"],function(e,t){"use strict";function r(){}t.noop=r}),define("src/layer/domain/dao/module/builder",["require","exports","arch-stream","src/lib/noop"],function(e,t,r,n){"use strict";function i(e,i,s){void 0===s&&(s=n.noop);var c=i();if(void Object.keys(t.SCHEMA).map(function(e){return t.SCHEMA[e].NAME}).reduce(function(e,t){delete c[t]},void 0),"string"!=typeof e[t.SCHEMA.KEY.NAME])throw new TypeError("LocalSocket: Invalid key: "+e[t.SCHEMA.KEY.NAME]);var d=r.assign(Object.keys(c).filter(o).filter(a(c)).reduce(function(t,r){var n=Object.getOwnPropertyDescriptor(c,r);if(n&&(n.get||n.set))return t;var i=c[r];return void 0===e[r]&&(e[r]=i),t[r]={configurable:!1,enumerable:!0,get:function(){return void 0===e[r]?i:e[r]},set:function(t){var n=e[r];t!==n&&(e[r]=void 0===t?i:t,void s(r,t,n))}},t},{}),(u={},u[t.SCHEMA.META.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.META.NAME]}},u[t.SCHEMA.ID.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.ID.NAME]}},u[t.SCHEMA.KEY.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.KEY.NAME]}},u[t.SCHEMA.DATE.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.DATE.NAME]}},u[t.SCHEMA.EVENT.NAME]={configurable:!1,enumerable:!1,get:function(){return e[t.SCHEMA.EVENT.NAME]}},u));return void Object.defineProperties(c,d),void Object.seal(c),c;var u}function o(e){return e.length>0&&"_"!==e[0]&&"_"!==e[e.length-1]&&s.test(e)}function a(e){return function(t){switch(typeof e[t]){case"undefined":case"boolean":case"number":case"string":case"object":return!0;default:return!1}}}t.SCHEMA={META:{NAME:"__meta"},ID:{NAME:"__id"},KEY:{NAME:"__key"},DATE:{NAME:"__date"},EVENT:{NAME:"__event"}},t.build=i;var s=/^[A-z_$][0-9A-z_$]*$/;t.isValidPropertyName=o,t.isValidPropertyValue=a}),define("src/layer/domain/dao/api",["require","exports","src/layer/domain/dao/module/builder"],function(e,t,r){"use strict";t.SCHEMA=r.SCHEMA,t.build=r.build,t.isValidPropertyName=r.isValidPropertyName,t.isValidPropertyValue=r.isValidPropertyValue}),define("src/layer/domain/indexeddb/model/types",["require","exports"],function(e,t){"use strict";function r(e){return+e}function n(e){return void 0!==e&&null!==e?e+"":""}t.IdNumber=r,t.KeyString=n}),define("src/layer/domain/lib/assign",["require","exports"],function(e,t){"use strict";function r(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(void 0===e||null===e)throw new TypeError("LocalSocket: assign: Cannot merge objects into "+e+".");for(var i=Object(e),o=0;o<t.length;o++){var a=t[o];if(void 0!==a&&null!==a){a=Object(a);for(var s=0,c=Object.keys(Object(a));s<c.length;s++){var d=c[s],u=Object.getOwnPropertyDescriptor(a,d);if(void 0!==u&&u.enumerable){var v=a[d],f=i[d];if(!v||"object"!=typeof v){i[d]=v;continue}if(Array.isArray(v)){i[d]=v.slice();continue}if(v instanceof Blob||v instanceof ImageData){i[d]=v;continue}if(f&&v&&"object"==typeof f&&!Array.isArray(f)){i[d]=r(f,v);continue}i[d]=r({},v)}}}}return i}t.assign=r}),define("src/layer/domain/indexeddb/model/store/event",["require","exports","arch-stream","src/layer/infrastructure/indexeddb/api","src/layer/domain/indexeddb/model/types","src/layer/domain/lib/assign","src/lib/noop"],function(e,t,r,n,i,o,a){"use strict";function s(e){function t(e){return e.map(function(e,t){return[e,t]}).sort(function(e,t){var r=e[0],n=e[1],i=t[0],o=t[1];return indexedDB.cmp(r.key,i.key)||i.date-r.date||o-n}).reduceRight(function(e,t){var n=e[0],i=e.slice(1),o=t[0],a=n[0];return a?a.key===o.key?r.concat([r.concat([o],n)],i):r.concat([[o]],r.concat([n],i)):[[o]]},[[]])}function n(e,t){switch(t.type){case c[c.put]:return void 0!==t.value[t.attr]?new v(t.key,o.assign(new d,e.value,t.value),c.snapshot):new v(t.key,Object.keys(e.value).reduce(function(r,n){return n===t.attr?r:(r[n]=e[n],r)},new d),c.snapshot);case c[c.snapshot]:return t;case c[c["delete"]]:return t}throw new TypeError("LocalSocket: Invalid event type: "+t.type)}return t(e).map(function(e){return e.reduceRight(n,new v(i.KeyString(""),new d,c["delete"]))})}!function(e){e[e.put=0]="put",e[e["delete"]=1]="delete",e[e.snapshot=2]="snapshot"}(t.EventType||(t.EventType={}));var c=t.EventType,d=function(){function e(){}return e}();t.EventValue=d;var u=function(){function e(e,t,r,n,i){if("number"==typeof this.id&&this.id>0==!1||void 0!==this.id)throw new TypeError("LocalSocket: EventRecord: Invalid event id: "+this.id);if(this.type=c[i],"string"!=typeof this.type||void 0===c[this.type])throw new TypeError("LocalSocket: EventRecord: Invalid event type: "+this.type);if(this.key=t,"string"!=typeof this.key)throw new TypeError("LocalSocket: EventRecord: Invalid event key: "+this.key);if(this.value=r,"object"!=typeof this.value||!this.value)throw new TypeError("LocalSocket: EventRecord: Invalid event value: "+this.value);if(this.date=n,"number"!=typeof this.date||this.date>=0==!1)throw new TypeError("LocalSocket: EventRecord: Invalid event date: "+this.date);if(this.attr=this.type===c[c.put]?Object.keys(r).reduce(function(e,t){return t.length>0&&"_"!==t[0]&&"_"!==t[t.length-1]?t:e},""):"","string"!=typeof this.attr)throw new TypeError("LocalSocket: EventRecord: Invalid event attr: "+this.key);if(this.type===c[c.put]&&0===this.attr.length)throw new TypeError("LocalSocket: EventRecord: Invalid event attr with "+this.type+": "+this.attr);if(this.type!==c[c.put]&&0!==this.attr.length)throw new TypeError("LocalSocket: EventRecord: Invalid event attr with "+this.type+": "+this.attr);switch(i){case c.put:return this.value=r=o.assign(new d,(a={},a[this.attr]=r[this.attr],a)),void void Object.freeze(this.value);case c.snapshot:return this.value=r=o.assign(new d,r),void void Object.freeze(this.value);case c["delete"]:default:return this.value=r=new d,void void Object.freeze(this.value)}throw new TypeError("LocalSocket: Invalid event type: "+i);var a}return e}(),v=function(e){function t(t,r,n,i){if(void 0===n&&(n=c.put),void 0===i&&(i=Date.now()),e.call(this,void 0,t,r,i,n),void 0!==this.id||"id"in this)throw new TypeError("LocalSocket: UnsavedEventRecord: Invalid event id: "+this.id)}return __extends(t,e),t}(u);t.UnsavedEventRecord=v;var f=function(e){function t(t,r,n,i,o){if(e.call(this,t,r,n,i,o),this.id=t,this.id>0==!1)throw new TypeError("LocalSocket: SavedEventRecord: Invalid event id: "+this.id);void Object.freeze(this)}return __extends(t,e),t}(u);t.SavedEventRecord=f,function(e){e[e.put=0]="put",e[e["delete"]=1]="delete",e[e.snapshot=2]="snapshot",e[e.get=3]="get"}(t.ESEventType||(t.ESEventType={}));var l=t.ESEventType,y=function(){function e(e,t,r,n){this.type=e,this.id=t,this.key=r,this.attr=n,void Object.freeze(this)}return e}();t.ESEvent=y;var p={id:"id",key:"key",type:"type",attr:"attr",value:"value",date:"date",surrogateKeyDateField:"key+date"},h=function(){function e(e,t){var n=this;this.access=e,this.name=t,this.cache=new r.Supervisor,this.events={sync:new r.Observable,load:new r.Observable,save:new r.Observable,loss:new r.Observable,access:new r.Observable},this.syncState=new r.Map,this.syncWaits=new r.Observable,this.snapshotCycle=10,this.snapshotJobState=new r.Map;var i=new r.Set(function(e,t){return t>e?t:e}),o=new r.Set(function(e,t){return t>e?t:e});void this.cache.events.exec.monitor([],function(e){var t=(e[0],e[1]),r=t(void 0);if(r instanceof f==!1)return void o.add(r.key,r.date);var a=function(){return!i.has(r.key)||r.id>i.get(r.key)},s=function(){return!o.has(r.key)||r.date>o.get(r.key)&&r.date>n.cache.cast([r.key],void 0).filter(function(e){return e!==r}).reduce(function(e,t){return t.date>e?t.date:e},0)};a()&&s()?(void i.add(r.key,r.id),void o.add(r.key,r.date),void n.events.load.emit([r.key,r.attr,r.type],new y(l[r.type],r.id,r.key,r.attr))):(void i.add(r.key,r.id),void o.add(r.key,r.date))})}return e.configure=function(e){return{make:function(t){var r=t.objectStoreNames.contains(e)?t.transaction(e).objectStore(e):t.createObjectStore(e,{keyPath:p.id,autoIncrement:!0});return r.indexNames.contains(p.id)||void r.createIndex(p.id,p.id,{unique:!0}),r.indexNames.contains(p.key)||void r.createIndex(p.key,p.key),r.indexNames.contains(p.type)||void r.createIndex(p.type,p.type),r.indexNames.contains(p.attr)||void r.createIndex(p.attr,p.attr),r.indexNames.contains(p.value)||void r.createIndex(p.value,p.value),r.indexNames.contains(p.date)||void r.createIndex(p.date,p.date),r.indexNames.contains(p.surrogateKeyDateField)||void r.createIndex(p.surrogateKeyDateField,[p.key,p.date]),!0},verify:function(t){return t.objectStoreNames.contains(e)&&t.transaction(e).objectStore(e).indexNames.contains(p.id)&&t.transaction(e).objectStore(e).indexNames.contains(p.key)&&t.transaction(e).objectStore(e).indexNames.contains(p.type)&&t.transaction(e).objectStore(e).indexNames.contains(p.attr)&&t.transaction(e).objectStore(e).indexNames.contains(p.value)&&t.transaction(e).objectStore(e).indexNames.contains(p.date)&&t.transaction(e).objectStore(e).indexNames.contains(p.surrogateKeyDateField)},destroy:function(){return!0}}},e.prototype.sync=function(e,t){if(void 0===t&&(t=a.noop),!this.syncState.has(e)||t!==a.noop)switch(this.syncState.get(e)){case!0:if(t===a.noop)return;return void void t();case!1:if(t===a.noop)return;return void void this.syncWaits.once(e,function(e){return void t(e)});default:return t===a.noop?void this.update(e):(void this.syncWaits.once(e,function(e){return void t(e)}),void void this.update(e))}},e.prototype.update=function(e){var t=this,i=this.head(e),o=[];void this.syncState.set(e,this.syncState.get(e)===!0),void this.cursor(e,p.key,n.IDBCursorDirection.prev,n.IDBTransaction.readonly,function(n,a){if(a)return void t.syncWaits.emit(e,a);if(!n||n.value.id<=i)return void o.reduceRight(function(e,t){return e.some(function(e){var r=e.attr;return r===t.attr})?e:r.concat([t],e)},[]).reduce(function(e,t){switch(c[t.type]){case c.put:return r.concat([t],e);default:return[t]}},[]).reduce(function(e,n){void t.cache.terminate([n.key,n.attr,r.sqid(n.id)]),void t.cache.register([n.key,n.attr,r.sqid(n.id)],function(e){return n})},void 0),void t.cache.cast([e],void 0),void t.syncState.set(e,!0),void t.syncWaits.emit(e,void 0),void(o.length>t.snapshotCycle&&void t.snapshot(e));var s=n.value;t.cache.refs([s.key,s.attr,r.sqid(s.id)]).length>0||(void o.unshift(new f(s.id,s.key,s.value,s.date,c[s.type])),s.type===c[c.put]&&void n["continue"]())})},e.prototype.heads=function(e){var t=[];void this.cursor(null,p.key,n.IDBCursorDirection.prevunique,n.IDBTransaction.readonly,function(r,n){if(!r)return void e(t,n);var i=r.value;void t.push(new f(i.id,i.key,i.value,i.date,c[i.type])),void r["continue"]()})},e.prototype.head=function(e){return this.cache.cast([e],void 0).reduce(function(e,t){return t.id>e?t.id:e},i.IdNumber(0))},e.prototype.meta=function(e){return Object.freeze(o.assign({id:0},this.cache.cast([e],void 0).reduce(function(e,t){return t.date>e.date?o.assign(e,t):e},o.assign({},new v(e,new d,c["delete"],0)))))},e.prototype.has=function(e){return s(this.cache.cast([e],void 0)).reduce(function(e){return e}).type!==c[c["delete"]]},e.prototype.get=function(e){return void this.sync(e),void this.events.access.emit([e],new y(l.get,i.IdNumber(0),e,"")),s(this.cache.cast([e],void 0)).reduce(function(e){return e}).value},e.prototype.add=function(e){var t=this;if(void this.events.access.emit([e.key,e.attr,e.type],new y(l[e.type],i.IdNumber(0),e.key,e.attr)),e instanceof v==!1)throw new Error("LocalSocket: Cannot add a saved event: "+JSON.stringify(e));void this.sync(e.key);var o=r.sqid();void this.cache.register([e.key,e.attr,r.sqid(0),o],function(t){return e}),void this.cache.cast([e.key,e.attr,r.sqid(0),o],void 0),void this.access(function(a){if(0!==t.cache.refs([e.key,e.attr,r.sqid(0)]).length){var s=a.transaction(t.name,n.IDBTransaction.readwrite),d=s.objectStore(t.name).add(e);s.oncomplete=function(n){var a=new f(i.IdNumber(d.result),e.key,e.value,e.date,c[e.type]);void t.cache.terminate([a.key,a.attr,r.sqid(0),o]),void t.cache.register([a.key,a.attr,r.sqid(a.id)],function(e){return a}),void t.events.save.emit([a.key,a.attr,a.type],new y(l[a.type],a.id,a.key,a.attr)),void t.cache.cast([a.key,a.attr,r.sqid(a.id)],void 0),t.cache.refs([e.key]).filter(function(e){var t=e[1];return t(void 0)instanceof f}).length>t.snapshotCycle&&void t.snapshot(e.key)},s.onerror=s.onabort=function(n){void setTimeout(function(){0!==t.cache.refs([e.key,e.attr,r.sqid(0),o]).length&&void t.events.loss.emit([e.key,e.attr,e.type],new y(l[e.type],e.id,e.key,e.attr))},1e3)}}})},e.prototype["delete"]=function(e){var t=this;void setTimeout(function(){return void t.clean(1/0,e)},10),void this.add(new v(e,new d,c["delete"]))},e.prototype.snapshot=function(e){var t=this;this.snapshotJobState.get(e)||(void this.snapshotJobState.set(e,!0),void this.access(function(r){var i=r.transaction(t.name,n.IDBTransaction.readwrite),o=i.objectStore(t.name),a=o.index(p.key).openCursor(e,n.IDBCursorDirection.prev),d=[];a.onsuccess=function(r){var n=a.result;if(n){var i=n.value;void d.unshift(new f(i.id,i.key,i.value,i.date,c[i.type]))}if(!n||c[n.value.type]!==c.put){if(d.length<t.snapshotCycle)return;void t.clean(1/0,e);var u=s(d).reduce(function(e){return e});if(u instanceof f)return;switch(u.type){case c[c.snapshot]:return void o.add(new v(u.key,u.value,c[u.type],d.reduce(function(e,t){return t.date>e?t.date:e},0)));case c[c["delete"]]:return}throw new TypeError("LocalSocket: Invalid event type: "+u.type)}void n["continue"]()},i.oncomplete=function(r){void t.snapshotJobState.set(e,!1),void t.update(e)},i.onerror=i.onabort=function(r){void t.snapshotJobState.set(e,!1)}}))},e.prototype.keys=function(e){void this.heads(function(t,r){return void e(t.map(function(e){var t=e.key;return t}),r)})},e.prototype.clean=function(e,t){var i=this;void 0===e&&(e=1/0);var o=[],a=new r.Map;void this.cursor(t?n.IDBKeyRange.bound([t,0],[t,e]):n.IDBKeyRange.upperBound(e),t?p.surrogateKeyDateField:p.date,n.IDBCursorDirection.prev,n.IDBTransaction.readwrite,function(e,t){if(!e)return void o.reduce(function(e,t){return void i.cache.terminate([t.key,t.attr,r.sqid(t.id)])},void 0);var n=e.value;switch(n.type){case c[c.put]:void a.set(n.key,a.get(n.key)||!1);break;case c[c.snapshot]:if(!a.get(n.key))return void a.set(n.key,!0),void void e["continue"]();break;case c[c["delete"]]:void a.set(n.key,!0);break;default:void a.set(n.key,!0)}a.get(n.key)&&(void e["delete"](),void o.unshift(n)),void e["continue"]()})},e.prototype.cursor=function(e,t,r,n,i){var o=this;void this.access(function(a){var s=a.transaction(o.name,n),c=t?s.objectStore(o.name).index(t).openCursor(e,r):s.objectStore(o.name).openCursor(e,r);c.onsuccess=function(e){return c.result&&i(c.result,c.error)},s.oncomplete=function(e){return void i(null,s.error)},s.onerror=s.onabort=function(e){return void i(null,s.error)}})},e}();t.AbstractEventStore=h,t.compose=s}),define("src/layer/domain/indexeddb/model/schema/socket/data",["require","exports","src/layer/domain/indexeddb/model/store/event"],function(e,t,r){"use strict";t.STORE_NAME="data",t.STORE_FIELDS={key:"key"};var n=function(){function e(){}return e}();t.DataValue=n;var i=function(e){function n(r){e.call(this,r,t.STORE_NAME),void Object.freeze(this)}return __extends(n,e),n.configure=function(){return r.AbstractEventStore.configure(t.STORE_NAME)},n}(r.AbstractEventStore);t.DataStore=i}),define("src/layer/domain/indexeddb/model/store/key-value",["require","exports","arch-stream","src/layer/infrastructure/indexeddb/api","src/lib/noop"],function(e,t,r,n,i){"use strict";!function(e){e[e.get=0]="get",e[e.put=1]="put",e[e["delete"]=2]="delete"}(t.EventType||(t.EventType={}));var o=t.EventType,a=function(){function e(e,t,n){if(this.access=e,this.name=t,this.index=n,this.cache=new r.Map,this.events={access:new r.Observable},"string"!=typeof n)throw new TypeError}return e.configure=function(){return{make:function(){return!0},verify:function(){return!0},destroy:function(){return!0}}},e.prototype.get=function(e,t){var r=this;return void 0===t&&(t=i.noop),void this.events.access.emit([e],[[e],o.get]),void this.access(function(i){var o,a=i.transaction(r.name,n.IDBTransaction.readonly),s=r.index?a.objectStore(r.name).index(r.index).get(e):a.objectStore(r.name).get(e);s.onsuccess=function(t){return o=void 0!==s.result&&null!==s.result?s.result:r.cache.get(e)},a.oncomplete=function(e){return t(o,a.error)},a.onerror=a.onabort=function(e){return t(void 0,a.error)}}),this.cache.get(e)},e.prototype.set=function(e,t,r){return void 0===r&&(r=i.noop),this.put(t,e,r)},e.prototype.put=function(e,t,r){var a=this;return void 0===r&&(r=i.noop),void this.cache.set(t,e),void this.events.access.emit([t],[[t],o.put]),void this.access(function(e){if(a.cache.has(t)){var i=e.transaction(a.name,n.IDBTransaction.readwrite);a.index?i.objectStore(a.name).put(a.cache.get(t)):i.objectStore(a.name).put(a.cache.get(t),t);i.oncomplete=i.onerror=i.onabort=function(e){return void r(t,i.error)}}}),this.cache.get(t)},e.prototype["delete"]=function(e,t){var r=this;void 0===t&&(t=i.noop),void this.cache["delete"](e),void this.events.access.emit([e],[[e],o["delete"]]),void this.access(function(i){var o=i.transaction(r.name,n.IDBTransaction.readwrite);o.objectStore(r.name)["delete"](e);o.oncomplete=o.onerror=o.onabort=function(e){return void t(o.error)}})},e.prototype.cursor=function(e,t,r,n,i){var o=this;void this.access(function(a){var s=a.transaction(o.name,n),c=t?s.objectStore(o.name).index(t).openCursor(e,r):s.objectStore(o.name).openCursor(e,r);c.onsuccess=function(e){return c.result&&i(c.result,c.error)},s.oncomplete=function(e){return void i(null,s.error)},s.onerror=s.onabort=function(e){return void i(null,s.error)}})},e}();t.AbstractKeyValueStore=a}),define("src/layer/domain/indexeddb/model/schema/socket/access",["require","exports","src/layer/domain/indexeddb/model/store/key-value","src/layer/domain/indexeddb/model/store/event"],function(e,t,r,n){"use strict";t.STORE_NAME="access",t.STORE_FIELDS={key:"key",date:"date"};var i=function(){function e(e,t){this.key=e,this.date=t}return e}(),o=function(e){function r(r,o){var a=this;e.call(this,r,t.STORE_NAME,t.STORE_FIELDS.key),void Object.freeze(this),void o.monitor([],function(e){var t=e.key,r=e.type;return r===n.ESEventType["delete"]?void a["delete"](t):void a.set(t,new i(t,Date.now()))})}return __extends(r,e),r.configure=function(){return{make:function(e){var r=e.objectStoreNames.contains(t.STORE_NAME)?e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME):e.createObjectStore(t.STORE_NAME,{keyPath:t.STORE_FIELDS.key,autoIncrement:!1});return r.indexNames.contains(t.STORE_FIELDS.key)||void r.createIndex(t.STORE_FIELDS.key,t.STORE_FIELDS.key,{unique:!0}),r.indexNames.contains(t.STORE_FIELDS.date)||void r.createIndex(t.STORE_FIELDS.date,t.STORE_FIELDS.date),!0},verify:function(e){return e.objectStoreNames.contains(t.STORE_NAME)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(t.STORE_FIELDS.key)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(t.STORE_FIELDS.date)},destroy:function(){return!0}}},r}(r.AbstractKeyValueStore);t.AccessStore=o}),define("src/layer/domain/indexeddb/model/schema/socket/expiry",["require","exports","src/layer/infrastructure/indexeddb/api","src/layer/domain/indexeddb/model/store/key-value","src/layer/domain/indexeddb/model/store/event"],function(e,t,r,n,i){"use strict";t.STORE_NAME="expiry",t.STORE_FIELDS={key:"key",expiry:"expiry"};var o=function(){function e(e,t){this.key=e,this.expiry=t}return e}(),a=function(e){function n(n,a,s){var c=this;e.call(this,n,t.STORE_NAME,t.STORE_FIELDS.key),void Object.freeze(this);var d=0,u=1/0,v=function(e){e>u||(void clearTimeout(d),u=e,d=setTimeout(function(){u=1/0,void c.cursor(null,t.STORE_FIELDS.expiry,r.IDBCursorDirection.next,r.IDBTransaction.readonly,function(e){if(e){var t=e.value;t.expiry>Date.now()?void v(t.expiry):(void a["delete"](t.key),void e["continue"]())}})},e-Date.now()))};void v(Date.now()),void a.events.access.monitor([],function(e){var t=e.key,r=e.type;if(r===i.ESEventType["delete"])void c["delete"](t);else{if(!s.has(t))return;var n=Date.now()+s.get(t);void c.set(t,new o(t,n)),void v(n)}})}return __extends(n,e),n.configure=function(){return{make:function(e){var r=e.objectStoreNames.contains(t.STORE_NAME)?e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME):e.createObjectStore(t.STORE_NAME,{keyPath:t.STORE_FIELDS.key,autoIncrement:!1});return r.indexNames.contains(t.STORE_FIELDS.key)||void r.createIndex(t.STORE_FIELDS.key,t.STORE_FIELDS.key,{unique:!0}),r.indexNames.contains(t.STORE_FIELDS.expiry)||void r.createIndex(t.STORE_FIELDS.expiry,t.STORE_FIELDS.expiry),!0},verify:function(e){return e.objectStoreNames.contains(t.STORE_NAME)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(t.STORE_FIELDS.key)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(t.STORE_FIELDS.expiry)},destroy:function(){return!0}}},n}(n.AbstractKeyValueStore);t.ExpiryStore=a}),define("src/layer/domain/indexeddb/model/schema/socket",["require","exports","arch-stream","src/layer/infrastructure/indexeddb/api","src/layer/domain/indexeddb/model/types","src/layer/domain/indexeddb/model/store/event","src/layer/domain/indexeddb/model/schema/socket/data","src/layer/domain/indexeddb/model/schema/socket/access","src/layer/domain/indexeddb/model/schema/socket/expiry","src/lib/noop"],function(e,t,r,n,i,o,a,s,c,d){"use strict";t.SocketRecord=o.UnsavedEventRecord,t.ESEventType=o.ESEventType,t.SocketValue=a.DataValue;var u=function(){function e(e,t,i){void 0===i&&(i=1/0),this.name=e,this.expiry=i,this.expiries=new r.Map;var o=n.open(e,{make:function(e){return a.DataStore.configure().make(e)&&s.AccessStore.configure().make(e)&&c.ExpiryStore.configure().make(e)},verify:function(e){return a.DataStore.configure().verify(e)&&s.AccessStore.configure().verify(e)&&c.ExpiryStore.configure().verify(e)},destroy:function(e,r){return a.DataStore.configure().destroy(e,r)&&s.AccessStore.configure().destroy(e,r)&&c.ExpiryStore.configure().destroy(e,r)&&t(e,r)}});this.schema=new v(o,this.expiries),this.events=this.schema.data.events}return e.prototype.sync=function(e,t){return void 0===t&&(t=d.noop),this.schema.data.sync(e,t)},e.prototype.keys=function(e){return void 0===e&&(e=d.noop),this.schema.data.keys(e)},e.prototype.has=function(e){return this.schema.data.has(i.KeyString(e))},e.prototype.get=function(e){return this.schema.data.get(i.KeyString(e))},e.prototype.add=function(e){return this.schema.data.add(e)},e.prototype["delete"]=function(e){return this.schema.data["delete"](i.KeyString(e))},e.prototype.meta=function(e){return this.schema.data.meta(i.KeyString(e))},e.prototype.head=function(e){return this.schema.data.head(i.KeyString(e))},e.prototype.expire=function(e,t){void 0===t&&(t=this.expiry),t!==1/0&&void this.expiries.set(e,t)},e.prototype.recent=function(e,t){var r=[];void this.schema.access.cursor(null,s.STORE_FIELDS.date,n.IDBCursorDirection.prevunique,n.IDBTransaction.readonly,function(n,i){return n?void(--e<0||(void r.push(n.primaryKey),void n["continue"]())):void t(r,i)})},e.prototype.clean=function(e,t){return void 0===e&&(e=1/0),this.schema.data.clean(e,t&&i.KeyString(t))},e.prototype.destroy=function(){return n.destroy(this.name)},e}();t.SocketStore=u;var v=function(){function e(e,t){this.data=new a.DataStore(e),this.access=new s.AccessStore(e,this.data.events.access),this.expire=new c.ExpiryStore(e,this.data,t),void Object.freeze(this)}return e}()}),define("src/layer/infrastructure/webstorage/module/global",["require","exports","arch-stream"],function(e,t,r){"use strict";var n=function(){try{var e="localsocket#"+r.uuid();if(void self.sessionStorage.setItem(e,e),e!==self.sessionStorage.getItem(e))throw 1;return void self.sessionStorage.removeItem(e),!0}catch(t){return!1}}();t.localStorage=n?self.localStorage:void 0,t.sessionStorage=n?self.sessionStorage:void 0}),define("src/layer/infrastructure/webstorage/model/event",["require","exports","arch-stream","src/layer/infrastructure/webstorage/module/global"],function(e,t,r,n){"use strict";var i={localStorage:new r.Observable,sessionStorage:new r.Observable};t.events=i,void window.addEventListener("storage",function(e){switch(e.storageArea){case n.localStorage:return void i.localStorage.emit("storage",e);case n.sessionStorage:return void i.sessionStorage.emit("storage",e)}})}),define("src/layer/infrastructure/webstorage/api",["require","exports","src/layer/infrastructure/webstorage/module/global","src/layer/infrastructure/webstorage/model/event"],function(e,t,r,n){"use strict";t.localStorage=r.localStorage,t.sessionStorage=r.sessionStorage,t.events=n.events}),define("src/layer/domain/webstorage/service/event",["require","exports","arch-stream","src/layer/infrastructure/webstorage/api"],function(e,t,r,n){"use strict";function i(e){var t=new r.Observable;return void e.on("storage",function(e){return void t.emit(e.key,e)}),t}t.events={localStorage:i(n.events.localStorage),sessionStorage:i(n.events.sessionStorage)}}),define("src/layer/domain/webstorage/repository/port",["require","exports","arch-stream","src/layer/domain/dao/api","src/layer/domain/webstorage/service/event","src/layer/infrastructure/webstorage/api","src/lib/noop"],function(e,t,r,n,i,o,a){"use strict";function s(e,t,r,n,i){return void 0===t&&(t=o.sessionStorage),void 0===n&&(n=0),void 0===i&&(i={add:function(e,t){},"delete":function(e){}}),new v(e,t,r,n,i)}var c=new r.Set,d=(new r.Set,new r.Set),u=(new r.Set,function(){function e(e,t,r,n,i){this.type=e,this.key=t,this.attr=r,this.newValue=n,this.oldValue=i}return e}());t.PortEvent=u,t.repository=s;var v=function(){function e(e,t,n,s,u){void 0===u&&(u={add:function(e,t){},
"delete":function(e){}}),this.name=e,this.storage=t,this.factory=n,this.life=s,this.expiry=u,this.event=new r.Observable,this.cache=this.storage===o.localStorage?c:d,this.eventSource=this.storage===o.localStorage?i.events.localStorage:i.events.sessionStorage,this.subscriber=a.noop,this.event.toJSON=function(){}}return e.prototype.link=function(){function e(e){try{return JSON.parse(e)}catch(t){return{}}}var t=this;if(this.cache.has(this.name))return this.cache.get(this.name);void this.close();var i=r.assign((s={},s[n.SCHEMA.KEY.NAME]=this.name,s[n.SCHEMA.EVENT.NAME]=this.event,s),e(this.storage.getItem(this.name)||"{}"));i.__event.toJSON=function(){};var a=n.build(i,this.factory,function(e,r,n){t.storage===o.localStorage&&null===t.storage.getItem(t.name)&&void t.expiry.add(t.name,t.life),void t.storage.setItem(t.name,JSON.stringify(i)),void t.event.emit(["send",e],new u("send",t.name,e,r,n))});return this.subscriber=function(r){var o=r.newValue,a=r.oldValue;if(o){var s=e(o);void Object.keys(s).filter(n.isValidPropertyName).filter(n.isValidPropertyValue(s)).reduce(function(e,t){var r=[s[t],i[t]],n=r[0],o=r[1];n!==o&&(i[t]=n)},void 0)}void t.event.emit(["recv"],new u("recv",t.name,"",o,a))},void this.eventSource.on(this.name,this.subscriber),void this.cache.add(this.name,a),void this.storage.setItem(this.name,JSON.stringify(i)),void this.expiry.add(this.name,this.life),a;var s},e.prototype.close=function(){void this.eventSource.off(this.name,this.subscriber),void this.cache["delete"](this.name)},e.prototype.destroy=function(){void this.close(),void this.storage.removeItem(this.name),void this.expiry["delete"](this.name)},e}()}),define("src/layer/domain/indexeddb/repository/socket",["require","exports","arch-stream","src/layer/domain/dao/api","src/layer/domain/indexeddb/model/schema/socket","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/repository/port","src/layer/domain/indexeddb/model/types","src/layer/domain/lib/assign"],function(e,t,r,n,i,o,a,s,c){"use strict";function d(e,t,r,n){return void 0===n&&(n=1/0),new f(e,t,n,r)}t.socket=d;var u=function(){function e(e,t,r){this.key=e,this.attr=t,this.date=r}return e}(),v=function(){function e(){this.msgs=[],this.msgHeadSet_=new r.Set(function(e,t){return t>e?t:e})}return e.prototype.recv=function(){var e=this;return this.msgs.map(function(e){return new u(e.key,e.attr,e.date)}).filter(function(t){return!e.msgHeadSet_.has(t.key)||t.date>e.msgHeadSet_.get(t.key)}).filter(function(t){return!void e.msgHeadSet_.add(t.key,t.date)})},e.prototype.send=function(e){this.msgs=r.concat([e],this.msgs.slice(0,9))},e}(),f=function(e){function t(t,s,c,d){var f=this;e.call(this,t,d,c),this.factory=s,this.proxy=a.repository(this.name,o.localStorage,function(){return new v}),this.port=this.proxy.link(),this.links=new r.Set,this.sources=new r.Set,void this.port.__event.monitor([],function(e){var t=e.type;e.newValue;switch(t){case"send":return;case"recv":return void f.port.recv().reduce(function(e,t){return void f.schema.data.update(t.key)},void 0)}}),void this.events.save.monitor([],function(e){var t=(e.id,e.key),r=e.attr;void f.port.send(new u(t,r,Date.now()))}),void this.events.load.monitor([],function(e){var t=(e.id,e.key),r=e.attr,o=e.type,s=f.sources.get(t);if(s)switch(o){case i.ESEventType.put:var c=s[r],d=f.get(t)[r];return s[r]=d,void void s.__event.emit(["recv",r],new a.PortEvent("recv",t,r,d,c));case i.ESEventType["delete"]:var u=f.get(t);return void void Object.keys(u).filter(n.isValidPropertyName).filter(n.isValidPropertyValue(u)).reduce(function(e,r){var n=s[r],i=void 0;s[r]=i,void s.__event.emit(["recv",r],new a.PortEvent("recv",t,r,i,n))},void 0);case i.ESEventType.snapshot:var v=f.get(t);return void void Object.keys(v).filter(n.isValidPropertyName).filter(n.isValidPropertyValue(v)).reduce(function(e,r){var n=s[r],i=v[r];s[r]=i,void s.__event.emit(["recv",r],new a.PortEvent("recv",t,r,i,n))},void 0)}})}return __extends(t,e),t.prototype.link=function(e,t){var o=this;if(void this.expire(e,t),this.links.has(e))return this.links.get(e);var d=this.sources.add(e,c.assign({},this.get(e)));void Object.defineProperties(d,{__meta:{get:function(){return o.meta(e)}},__id:{get:function(){return this.__meta.id}},__key:{get:function(){return this.__meta.key}},__date:{get:function(){return this.__meta.date}},__event:{value:new r.Observable}});var u=this.links.add(e,n.build(d,this.factory,function(t,r,n){void o.add(new i.SocketRecord(s.KeyString(e),(c={},c[t]=r,c))),void d.__event.emit(["send",t],new a.PortEvent("send",e,t,r,n));var c}));return u},t.prototype.close=function(){void this.proxy.close()},t.prototype.destroy=function(){void this.close(),void this.proxy.destroy(),void e.prototype.destroy.call(this)},t}(i.SocketStore)}),define("src/layer/domain/indexeddb/service/event",["require","exports","src/layer/infrastructure/indexeddb/api"],function(e,t,r){"use strict";t.event=r.event}),define("src/layer/domain/indexeddb/api",["require","exports","src/layer/domain/indexeddb/repository/socket","src/layer/domain/indexeddb/service/event"],function(e,t,r,n){"use strict";t.socket=r.socket,t.event=n.event}),define("src/layer/domain/webstorage/service/expiry",["require","exports","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/repository/port"],function(e,t,r,n){"use strict";var i=function(){function e(){this.expiries={}}return e.prototype.add=function(e,t){this.expiries[e]=this.expiries[e]||new o(e,new a(t))},e.prototype["delete"]=function(e){delete this.expiries[e]},e.prototype.commit=function(){this.expiries=this.expiries},e.prototype.entries=function(){var e=this;return Object.keys(this.expiries).map(function(t){return[t,e.expiries[t]]})},e}();t.WebStorageExpiry=i;var o=function(){function e(e,t){this.name=e,this.life=t}return e}(),a=function(){function e(e){this.max=e,this.atime=Date.now(),this.value=this.max}return e}(),s="localsocket::expiry";t.expiry=r.localStorage?n.repository(s,r.localStorage,function(){return new i},1/0).link():new i}),define("src/layer/domain/webstorage/service/clean",["require","exports","src/layer/domain/webstorage/repository/port"],function(e,t,r){"use strict";function n(e,t,n){void 0===n&&(n=Date.now()),t&&(void e.entries().reduce(function(i,o){var a=o[0],s=o[1].life;s.atime+864e5>n?s.value=s.max:(s.atime=n,void--s.value),s.value<0&&void r.repository(a,t,function(){return{}},0,e).destroy()},void 0),void e.commit())}t.clean=n}),define("src/layer/domain/webstorage/api",["require","exports","src/layer/domain/webstorage/repository/port","src/layer/domain/webstorage/service/expiry","src/layer/domain/webstorage/service/clean","src/layer/infrastructure/webstorage/api","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/service/event"],function(e,t,r,n,i,o,a,s){"use strict";function c(e,t,i,a){return r.repository(e,t,i,a,t===o.localStorage?n.expiry:void 0)}t.localStorage=a.localStorage,t.sessionStorage=a.sessionStorage,t.events=s.events,t.webstorage=c,void i.clean(n.expiry,o.localStorage),void setInterval(function(){return void i.clean(n.expiry,o.localStorage)},36e5)}),define("src/layer/app/api",["require","exports","src/layer/domain/indexeddb/api","src/layer/domain/webstorage/api","src/layer/domain/indexeddb/api","src/layer/domain/webstorage/api"],function(e,t,r,n,i,o){"use strict";function a(e,t){function n(e){var t=function(){function e(e,t,r){void 0===e&&(e=1/0),void 0===r&&(r=function(){return!0}),this.expiry=e,this.factory=t,this.destroy=r,void Object.freeze(this)}return e}();return new t(e.expiry,e.factory,e.destroy)}return t=n(t),r.socket(e,t.factory,t.destroy,t.expiry)}function s(e,t){function r(e){var t=function(){function e(e,t,r){void 0===e&&(e=10),void 0===r&&(r=function(){return!0}),this.life=e,this.factory=t,this.destroy=r,void Object.freeze(this)}return e}();return new t(e.life,e.factory,e.destroy)}return t=r(t),n.webstorage(e,n.localStorage,t.factory,t.life)}t.socket=a,t.port=s;var c;!function(e){e.indexedDB=i.event,e.localStorage=o.events.localStorage,e.sessionStorage=o.events.sessionStorage}(c=t.events||(t.events={}))}),define("src/layer/interface/api",["require","exports","src/layer/app/api"],function(e,t,r){"use strict";t.socket=r.socket,t.port=r.port,t.events=r.events}),define("src/export",["require","exports","src/layer/interface/api"],function(e,t,r){"use strict";t["default"]=r.socket,t.socket=r.socket,t.port=r.port}),define("localsocket",["require","exports","src/export","src/export"],function(e,t,r,n){"use strict";function i(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}i(r),t["default"]=n["default"]}),define("src/layer/domain/indexeddb/model/api",["require","exports","src/layer/infrastructure/indexeddb/api"],function(e,t,r){"use strict";t.IDBKeyRange=r.IDBKeyRange});