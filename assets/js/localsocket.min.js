/*! localsocket v0.0.1 https://github.com/falsandtru/localsocket | (c) 2015, falsandtru | MIT Licence */
/*! Link: MIT Lisence http://www.opensource.org/licenses/mit-license.php */
define="function"==typeof define&&define.amd?define:function(){"use strict";var e="localsocket",t={};return function r(n,o,i){return i?void i.apply(this,o.map(function(e){switch(e){case"require":return"function"==typeof require?require:void 0;case"exports":return-1===n.indexOf("/")?t[n]="undefined"==typeof exports?self[n]=self[n]||{}:exports:t[n]=t.hasOwnProperty(n)?t[n]:{};default:return".d"===e.slice(-2)&&{}||t.hasOwnProperty(e)&&t[e]||"function"==typeof require&&require(e)||self[e]}})):void r(e,n,o)}}();var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define("src/layer/infrastructure/indexeddb/module/global",["require","exports"],function(e,t){"use strict";t.indexedDB=self.indexedDB||self.webkitIndexedDB||self.mozIndexedDB||self.msIndexedDB;var r=self.IDBKeyRange||self.webkitIDBKeyRange||self.mozIDBKeyRange||self.msIDBKeyRange;t.IDBKeyRange=r;var n;!function(e){e.readonly="readonly",e.readwrite="readwrite"}(n=t.IDBTransaction||(t.IDBTransaction={}));var o;!function(e){e.next="next",e.nextunique="nextunique",e.prev="prev",e.prevunique="prevunique"}(o=t.IDBCursorDirection||(t.IDBCursorDirection={}))}),define("src/layer/infrastructure/indexeddb/model/event",["require","exports"],function(e,t){"use strict";!function(e){e[e.connect=0]="connect",e[e.disconnect=1]="disconnect",e[e.block=2]="block",e[e.error=3]="error",e[e.abort=4]="abort",e[e.crash=5]="crash",e[e.destroy=6]="destroy"}(t.IDBEvenType||(t.IDBEvenType={}));var r,n=t.IDBEvenType;!function(e){e.connect=n[n.connect],e.disconnect=n[n.disconnect],e.block=n[n.block],e.error=n[n.error],e.abort=n[n.abort],e.crash=n[n.crash],e.destroy=n[n.destroy]}(r=t.IDBEventName||(t.IDBEventName={}));var o=function(){function e(e,t){this.name=t,this.namespace=[this.name],this.type=n[e],void Object.freeze(this)}return e}();t.IDBEvent=o}),define("src/layer/infrastructure/indexeddb/model/access",["require","exports","arch-stream","src/layer/infrastructure/indexeddb/module/global","src/layer/infrastructure/indexeddb/model/event"],function(e,t,r,n,o){"use strict";function i(e,r){return void w.set(e,0),void t.ConfigMap.set(e,r),k.get(e)||(void k.add(e,!0),void u(e)),function(t){var r=E.get(e)||E.add(e,[]);void r.push(t),void d(e)}}function a(e){return function(t){var r=E.get(e)||E.add(e,[]);void r.push(t),void d(e)}}function s(e){return void w.set(e,1),void t.ConfigMap.set(e,{make:function(){return!1},verify:function(){return!1},destroy:function(){return!1}}),x.get(e)?x.get(e).end():void(k.get(e)||(void k.add(e,!0),void u(e)))}function c(e){return void w.set(e,2),void t.ConfigMap.set(e,{make:function(){return!1},verify:function(){return!1},destroy:function(){return!0}}),x.get(e)?x.get(e).destroy():void(k.get(e)||(void k.add(e,!0),void u(e)))}function d(e){for(var t=x.get(e),r=E.get(e)||[];;)try{for(;t&&r.length>0&&0===w.get(e);)void r[0](t),void r.shift();break}catch(n){void console.error(n,n+""),void h(e,n)}}function u(e,r){void 0===r&&(r=0);t.ConfigMap.get(e);try{var o=r?n.indexedDB.open(e,r):n.indexedDB.open(e);o.onupgradeneeded=function(t){return void l(e,o)},o.onsuccess=function(t){return void f(e,o.result)},o.onblocked=function(t){return void v(e,o)},o.onerror=function(t){return void y(e,o.error,t)}}catch(i){void h(e,i)}}function v(e,t){void b.emit(new o.IDBEvent(o.IDBEvenType.block,e))}function l(e,r){var n=r.result,o=t.ConfigMap.get(e),i=o.make,a=o.destroy;try{i(n)?(r.onsuccess=function(t){return void f(e,n)},r.onerror=function(t){return void y(e,r.error,t)}):r.onsuccess=r.onerror=function(t){void n.close(),a(r.error,t)?void m(e):void g(e)}}catch(s){void h(e,s)}}function f(e,r){switch(r.onversionchange=function(e){return void r.close()},r.end=function(){void x["delete"](e),void r.close(),void g(e)},r.destroy=function(){void x["delete"](e),void r.close(),void m(e)},r.onerror=function(t){void x["delete"](e),void y(e,t.target.error,t)},r.onabort=function(t){void x["delete"](e),void p(e,t.target.error,t)},w.get(e)){case 0:var n=t.ConfigMap.get(e).verify;try{if(!n(r))return void g(e,+r.version+1);void b.emit(new o.IDBEvent(o.IDBEvenType.connect,e)),void x.add(e,r),void d(e)}catch(i){void h(e,i)}return;case 1:return void r.end();case 2:return void r.destroy()}throw new TypeError("LocalSocket: Invalid command "+w.get(e)+".")}function y(e,r,n){void n.preventDefault(),void x["delete"](e),void b.emit(new o.IDBEvent(o.IDBEvenType.error,e));var i=t.ConfigMap.get(e).destroy;return i(r,n)?void m(e):void g(e)}function p(e,r,n){void n.preventDefault(),void x["delete"](e),void b.emit(new o.IDBEvent(o.IDBEvenType.abort,e));var i=t.ConfigMap.get(e).destroy;return i(r,n)?void m(e):void g(e)}function h(e,r){void x["delete"](e),void b.emit(new o.IDBEvent(o.IDBEvenType.crash,e));var n=t.ConfigMap.get(e).destroy;return n(r,null)?void m(e):void g(e)}function m(e){void x["delete"](e);var t=n.indexedDB.deleteDatabase(e);t.onsuccess=function(t){return void E["delete"](e),void b.emit(new o.IDBEvent(o.IDBEvenType.destroy,e)),void g(e)},t.onerror=function(r){void y(e,t.error,r)}}function g(e,r){switch(void 0===r&&(r=0),void x["delete"](e),void b.emit(new o.IDBEvent(o.IDBEvenType.disconnect,e)),w.get(e)){case 0:return void u(e,r);case 1:return void t.ConfigMap["delete"](e),void void k["delete"](e);case 2:return void t.ConfigMap["delete"](e),void void k["delete"](e)}throw new TypeError("LocalSocket: Invalid command "+w.get(e)+".")}var b=new r.Observable;t.event=b,t.ConfigMap=new r.Map;var S;!function(e){e[e.open=0]="open",e[e.close=1]="close",e[e.destroy=2]="destroy"}(S||(S={}));var w=new r.Map,E=new r.Set,k=new r.Set,x=new r.Set;t.open=i,t.listen=a,t.close=s,t.destroy=c}),define("src/layer/infrastructure/indexeddb/api",["require","exports","src/layer/infrastructure/indexeddb/module/global","src/layer/infrastructure/indexeddb/model/access","src/layer/infrastructure/indexeddb/model/event"],function(e,t,r,n,o){"use strict";t.indexedDB=r.indexedDB,t.IDBKeyRange=r.IDBKeyRange,t.IDBTransaction=r.IDBTransaction,t.IDBCursorDirection=r.IDBCursorDirection,t.open=n.open,t.listen=n.listen,t.close=n.close,t.destroy=n.destroy,t.event=n.event,t.IDBEvent=o.IDBEvent,t.IDBEventName=o.IDBEventName}),define("src/layer/app/module/config",["require","exports"],function(e,t){"use strict";function r(e){return new n(e.life,e.factory,e.destroy)}t.configure=r;var n=function(){function e(e,t,r){void 0===e&&(e=10),void 0===r&&(r=function(){return!0}),this.life=e,this.factory=t,this.destroy=r}return e}()}),define("src/lib/noop",["require","exports"],function(e,t){"use strict";function r(){}t.noop=r}),define("src/layer/domain/dao/module/builder",["require","exports","arch-stream","src/lib/noop"],function(e,t,r,n){"use strict";function o(e,o,s){void 0===s&&(s=n.noop);var c=o();if(void Object.keys(t.SCHEMA).map(function(e){return t.SCHEMA[e].NAME}).reduce(function(e,t){delete c[t]},void 0),"string"!=typeof e[t.SCHEMA.KEY.NAME])throw new TypeError("LocalSocket: Invalid key: "+e[t.SCHEMA.KEY.NAME]);var d=r.assign(Object.keys(c).filter(i).filter(a(c)).reduce(function(t,r){var n=Object.getOwnPropertyDescriptor(c,r);return n&&(n.get||n.set)?t:(void 0===e[r]&&(e[r]=c[r]),t[r]={configurable:!1,enumerable:!0,get:function(){return e[r]},set:function(t){var n=e[r];t!==n&&(e[r]=t,void s(r,t,n))}},t)},{}),(u={},u[t.SCHEMA.ID.NAME]={configurable:!1,enumerable:!0,get:function(){return e[t.SCHEMA.ID.NAME]}},u[t.SCHEMA.KEY.NAME]={configurable:!1,enumerable:!0,get:function(){return e[t.SCHEMA.KEY.NAME]}},u[t.SCHEMA.EVENT.NAME]={configurable:!1,enumerable:!0,get:function(){return e[t.SCHEMA.EVENT.NAME]}},u));return void Object.defineProperties(c,d),void Object.seal(c),c;var u}function i(e){return e.length>0&&"_"!==e[0]&&"_"!==e[e.length-1]&&s.test(e)}function a(e){return function(t){switch(typeof e[t]){case"undefined":case"boolean":case"number":case"string":case"object":return!0;default:return!1}}}t.SCHEMA={ID:{NAME:"__id"},KEY:{NAME:"__key"},EVENT:{NAME:"__event"}},t.build=o;var s=/^[A-z_$][0-9A-z_$]*$/;t.isValidPropertyName=i,t.isValidPropertyValue=a}),define("src/layer/domain/dao/api",["require","exports","src/layer/domain/dao/module/builder"],function(e,t,r){"use strict";t.SCHEMA=r.SCHEMA,t.build=r.build,t.isValidPropertyName=r.isValidPropertyName,t.isValidPropertyValue=r.isValidPropertyValue}),define("src/layer/domain/indexeddb/model/types",["require","exports"],function(e,t){"use strict";function r(e){return+e}function n(e){return void 0!==e&&null!==e?e+"":""}t.IdNumber=r,t.KeyString=n}),define("src/layer/domain/lib/assign",["require","exports"],function(e,t){"use strict";function r(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(void 0===e||null===e)throw new TypeError("LocalSocket: assign: Cannot merge objects into "+e+".");for(var o=Object(e),i=0;i<t.length;i++){var a=t[i];if(void 0!==a&&null!==a){a=Object(a);for(var s=0,c=Object.keys(Object(a));s<c.length;s++){var d=c[s],u=Object.getOwnPropertyDescriptor(a,d);if(void 0!==u&&u.enumerable){var v=a[d],l=o[d];if(!v||"object"!=typeof v){o[d]=v;continue}if(Array.isArray(v)){o[d]=v.slice();continue}if(v instanceof Blob||v instanceof ImageData){o[d]=v;continue}if(l&&v&&"object"==typeof l&&!Array.isArray(l)){o[d]=r(l,v);continue}o[d]=r({},v)}}}}return o}t.assign=r}),define("src/layer/domain/indexeddb/model/store/event",["require","exports","arch-stream","src/layer/infrastructure/indexeddb/api","src/layer/domain/indexeddb/model/types","src/layer/domain/lib/assign"],function(e,t,r,n,o,i){"use strict";function a(e){function t(e){return e.map(function(e,t){return[e,t]}).sort(function(e,t){var r=e[0],n=e[1],o=t[0],i=t[1];return indexedDB.cmp(r.key,o.key)||o.date-r.date||i-n}).reduceRight(function(e,t){var n=e[0],o=e.slice(1),i=t[0],a=n[0];return a?a.key===i.key?r.concat([r.concat([i],n)],o):r.concat([[i]],r.concat([n],o)):[[i]]},[[]])}function n(e,t){switch(t.type){case s[s.put]:return void 0!==t.value[t.attr]?new u(t.key,i.assign(new c,e.value,t.value),s.snapshot):new u(t.key,Object.keys(e.value).reduce(function(r,n){return n===t.attr?r:(r[n]=e[n],r)},new c),s.snapshot);case s[s.snapshot]:return new u(t.key,i.assign(new c,t.value),s.snapshot);case s[s["delete"]]:return new u(t.key,new c,s["delete"]);default:return new u(t.key,i.assign(new c,e.value,t.value),s.snapshot)}throw new TypeError("LocalSocket: Invalid event type: "+t.type)}return t(e).map(function(e){return e.reduceRight(n,new u(o.KeyString(""),new c,s["delete"]))})}!function(e){e[e.put=0]="put",e[e["delete"]=1]="delete",e[e.snapshot=2]="snapshot"}(t.EventType||(t.EventType={}));var s=t.EventType,c=function(){function e(){}return e}();t.EventValue=c;var d=function(){function e(e,t,r,n,o){if("number"==typeof this.id&&this.id>0==!1||void 0!==this.id)throw new TypeError("LocalSocket: EventRecord: Invalid event id: "+this.id);if(this.type=s[o],"string"!=typeof this.type)throw new TypeError("LocalSocket: EventRecord: Invalid event type: "+this.type);if(this.key=t,"string"!=typeof this.key)throw new TypeError("LocalSocket: EventRecord: Invalid event key: "+this.key);if(this.value=r,"object"!=typeof this.value||!this.value)throw new TypeError("LocalSocket: EventRecord: Invalid event value: "+this.value);if(this.date=n,"number"!=typeof this.date||this.date>0==!1)throw new TypeError("LocalSocket: EventRecord: Invalid event date: "+this.date);if(this.attr=this.type===s[s.put]?Object.keys(r).reduce(function(e,t){return t.length>0&&"_"!==t[0]&&"_"!==t[t.length-1]?t:e},""):"","string"!=typeof this.attr)throw new TypeError("LocalSocket: EventRecord: Invalid event attr: "+this.key);if(this.type===s[s.put]&&0===this.attr.length)throw new TypeError("LocalSocket: EventRecord: Invalid event attr with "+this.type+": "+this.attr);if(this.type!==s[s.put]&&0!==this.attr.length)throw new TypeError("LocalSocket: EventRecord: Invalid event attr with "+this.type+": "+this.attr);switch(o){case s.put:return void(this.value=r=i.assign(new c,(a={},a[this.attr]=r[this.attr],a)));case s.snapshot:return void(this.value=r=i.assign(new c,r));case s["delete"]:default:return void(this.value=r=new c)}throw new TypeError("LocalSocket: Invalid event type: "+o);var a}return e}(),u=function(e){function t(t,r,n){if(void 0===n&&(n=s.put),e.call(this,void 0,t,r,Date.now(),n),void 0!==this.id||"id"in this)throw new TypeError("LocalSocket: EventRecord: Invalid event id: "+this.id)}return __extends(t,e),t}(d);t.UnsavedEventRecord=u;var v=function(e){function t(t,r,n,o,i){if(e.call(this,t,r,n,o,i),this.id=t,"number"!=typeof this.id||this.id>0==!1)throw new TypeError("LocalSocket: EventRecord: Invalid event id: "+this.id)}return __extends(t,e),t}(d);t.SavedEventRecord=v;var l={id:"id",key:"key",type:"type",attr:"attr",value:"value",date:"date",surrogateKeyDateField:"key+date"},f=function(){function e(e,t){var n=this;this.access=e,this.name=t,this.cache=new r.Supervisor,this.events={sync:new r.Observable,load:new r.Observable,save:new r.Observable,loss:new r.Observable,access:new r.Observable},this.syncedKeyMap=new r.Map,this.snapshotCycle=10,this.snapshotJobState=new r.Map;var o=new r.Set(function(e,t){return t>e?t:e}),i=new r.Set(function(e,t){return t>e?t:e});void this.cache.events.exec.monitor([],function(e){var t=(e[0],e[1]),r=t(void 0);if(r.id>0==!1)return void i.add(r.key,r.date);var a=function(){return!o.has(r.key)||r.id>o.get(r.key)},c=function(){return!i.has(r.key)||r.date>i.get(r.key)&&r.date>n.cache.cast([r.key],void 0).filter(function(e){return e!==r}).reduce(function(e,t){return t.date>e?t.date:e},0)};a()&&c()?(void o.add(r.key,r.id),void i.add(r.key,r.date),void n.events.load.emit([r.key,r.attr,r.type],[r.key,r.attr,s[r.type]])):(void o.add(r.key,r.id),void i.add(r.key,r.date))})}return e.configure=function(e){return{make:function(t){var r=t.objectStoreNames.contains(e)?t.transaction(e).objectStore(e):t.createObjectStore(e,{keyPath:l.id,autoIncrement:!0});return r.indexNames.contains(l.id)||void r.createIndex(l.id,l.id,{unique:!0}),r.indexNames.contains(l.key)||void r.createIndex(l.key,l.key),r.indexNames.contains(l.type)||void r.createIndex(l.type,l.type),r.indexNames.contains(l.attr)||void r.createIndex(l.attr,l.attr),r.indexNames.contains(l.value)||void r.createIndex(l.value,l.value),r.indexNames.contains(l.date)||void r.createIndex(l.date,l.date),r.indexNames.contains(l.surrogateKeyDateField)||void r.createIndex(l.surrogateKeyDateField,[l.key,l.date]),!0},verify:function(t){return t.objectStoreNames.contains(e)&&t.transaction(e).objectStore(e).indexNames.contains(l.id)&&t.transaction(e).objectStore(e).indexNames.contains(l.key)&&t.transaction(e).objectStore(e).indexNames.contains(l.type)&&t.transaction(e).objectStore(e).indexNames.contains(l.attr)&&t.transaction(e).objectStore(e).indexNames.contains(l.value)&&t.transaction(e).objectStore(e).indexNames.contains(l.date)&&t.transaction(e).objectStore(e).indexNames.contains(l.surrogateKeyDateField)},destroy:function(){return!0}}},e.prototype.sync=function(e){return this.syncedKeyMap.has(e)?void this.syncedKeyMap.get(e):void this.syncedKeyMap.set(e,!!void this.update(e))},e.prototype.update=function(e){var t=this,o=this.head(e),i=[];void this.cursor(e,l.key,n.IDBCursorDirection.prev,n.IDBTransaction.readonly,function(n,a){if(a)return void(t.syncedKeyMap.get(e)===!1&&void t.syncedKeyMap["delete"](e));if(!n||n.value.id<=o)return void i.reduceRight(function(e,t){return e.some(function(e){var r=e.attr;return r===t.attr})?e:r.concat([t],e)},[]).reduce(function(e,t){switch(s[t.type]){case s.put:return r.concat([t],e);default:return[t]}},[]).reduce(function(e,n){void t.cache.terminate([n.key,n.attr,r.sqid(n.id)]),void t.cache.register([n.key,n.attr,r.sqid(n.id)],function(e){return n})},void 0),void t.cache.cast([e],void 0),t.syncedKeyMap.get(e)!==!0&&(void t.syncedKeyMap.set(e,!0),void t.events.sync.emit([e],[e])),void(i.length>t.snapshotCycle&&void t.snapshot(e));var c=n.value;t.cache.refs([c.key,c.attr,r.sqid(c.id)]).length>0||(void i.unshift(new v(c.id,c.key,c.value,c.date,s[c.type])),c.type===s[s.put]&&void n["continue"]())})},e.prototype.heads=function(e){var t=[];void this.cursor(null,l.key,n.IDBCursorDirection.prevunique,n.IDBTransaction.readonly,function(r,n){if(!r)return void e(t,n);var o=r.value;void t.push(o),void r["continue"]()})},e.prototype.head=function(e){return this.cache.cast([e],void 0).reduce(function(e,t){return t.id>e?t.id:e},o.IdNumber(0))},e.prototype.has=function(e){return a(this.cache.cast([e],void 0)).reduce(function(e){return e}).type!==s[s["delete"]]},e.prototype.get=function(e){return void this.sync(e),void this.events.access.emit([e],[e,"",void 0]),a(this.cache.cast([e],void 0)).reduce(function(e){return e}).value},e.prototype.add=function(e){var t=this;if(void this.events.access.emit([e.key,e.attr,e.type],[e.key,e.attr,s[e.type]]),void 0!==e.id||e instanceof u==!1)throw new Error("LocalSocket: Cannot add a saved event: "+JSON.stringify(e));void this.sync(e.key);var i=r.sqid();return void this.cache.register([e.key,e.attr,r.sqid(0),i],function(t){return e}),void this.cache.cast([e.key,e.attr,r.sqid(0),i],void 0),void this.access(function(a){if(0!==t.cache.refs([e.key,e.attr,r.sqid(0)]).length){var c=a.transaction(t.name,n.IDBTransaction.readwrite),d=c.objectStore(t.name).add(e);c.oncomplete=function(n){var a=new v(o.IdNumber(d.result),e.key,e.value,e.date,s[e.type]);void t.cache.terminate([a.key,a.attr,r.sqid(0),i]),void t.cache.register([a.key,a.attr,r.sqid(a.id)],function(e){return a}),void t.events.save.emit([a.key,a.attr,a.type],[a.key,a.attr,s[a.type]]),void t.cache.cast([a.key,a.attr,r.sqid(a.id)],void 0),t.cache.refs([e.key]).filter(function(e){var t=e[1];return t(void 0)instanceof v}).length>t.snapshotCycle&&void t.snapshot(e.key)},c.onerror=c.onabort=function(n){void setTimeout(function(){0!==t.cache.refs([e.key,e.attr,r.sqid(0),i]).length&&void t.events.loss.emit([e.key,e.attr,e.type],[e.key,e.attr,s[e.type]])},1e3)}}}),this},e.prototype["delete"]=function(e){var t=this;return void setTimeout(function(){return void t.clean(1/0,e)},10),this.add(new u(e,new c,s["delete"]))},e.prototype.snapshot=function(e){var t=this;if(!this.snapshotJobState.get(e))return void this.snapshotJobState.set(e,!0),void this.access(function(r){var o=r.transaction(t.name,n.IDBTransaction.readwrite),i=o.objectStore(t.name),c=i.index(l.key).openCursor(e,n.IDBCursorDirection.prev),d=[];c.onsuccess=function(r){var n=c.result;if(n){var o=n.value;void d.unshift(new v(o.id,o.key,o.value,o.date,s[o.type]))}if(!n||s[n.value.type]!==s.put){if(d.length<t.snapshotCycle)return;var u=a(d).reduce(function(e){return e});if(u.date=d.reduce(function(e,t){return t.date>e?t.date:e},0),void t.clean(1/0,e),u.id>0)return;switch(u.type){case s[s.snapshot]:if(void 0!==u.id)throw new Error("LocalSocket: Cannot add a saved event: "+JSON.stringify(u));return void i.add(u)}throw new TypeError("LocalSocket: Invalid event type: "+u.type)}void n["continue"]()},o.oncomplete=function(r){void t.snapshotJobState.set(e,!1),void t.update(e)},o.onerror=o.onabort=function(r){void t.snapshotJobState.set(e,!1)}}),this},e.prototype.keys=function(e){void this.heads(function(t,r){return void e(t.map(function(e){var t=e.key;return t}),r)})},e.prototype.clean=function(e,t){var o=this;void 0===e&&(e=1/0);var i=[],a=new r.Map;void this.cursor(t?n.IDBKeyRange.bound([t,0],[t,e]):n.IDBKeyRange.upperBound(e),t?l.surrogateKeyDateField:l.date,n.IDBCursorDirection.prev,n.IDBTransaction.readwrite,function(e,t){if(!e)return void i.reduce(function(e,t){return void o.cache.terminate([t.key,t.attr,r.sqid(t.id)])},void 0);var n=e.value;switch(n.type){case s[s.put]:void a.set(n.key,a.get(n.key)||!1);break;case s[s.snapshot]:if(!a.get(n.key))return void a.set(n.key,!0),void void e["continue"]();break;case s[s["delete"]]:void a.set(n.key,!0);break;default:void a.set(n.key,!0)}a.get(n.key)&&(void e["delete"](),void i.unshift(n)),void e["continue"]()})},e.prototype.cursor=function(e,t,r,n,o){var i=this;void this.access(function(a){var s=a.transaction(i.name,n),c=t?s.objectStore(i.name).index(t).openCursor(e,r):s.objectStore(i.name).openCursor(e,r);c.onsuccess=function(e){return c.result&&o(c.result,c.error)},s.oncomplete=function(e){return void o(null,s.error)},s.onerror=s.onabort=function(e){return void o(null,s.error)}})},e}();t.AbstractEventStore=f,t.compose=a}),define("src/layer/domain/indexeddb/model/schema/storage/data",["require","exports","src/layer/domain/indexeddb/model/store/event"],function(e,t,r){"use strict";t.STORE_NAME="data",t.STORE_FIELDS={key:"key"};var n=function(){function e(){}return e}();t.DataValue=n;var o=function(e){function n(r){e.call(this,r,t.STORE_NAME),void Object.freeze(this)}return __extends(n,e),n.configure=function(){return r.AbstractEventStore.configure(t.STORE_NAME)},n}(r.AbstractEventStore);t.DataStore=o}),define("src/layer/domain/indexeddb/model/store/key-value",["require","exports","arch-stream","src/layer/infrastructure/indexeddb/api","src/lib/noop"],function(e,t,r,n,o){"use strict";!function(e){e[e.get=0]="get",e[e.put=1]="put",e[e["delete"]=2]="delete"}(t.EventType||(t.EventType={}));var i=t.EventType,a=function(){function e(e,t,n){if(this.access=e,this.name=t,this.index=n,this.cache=new r.Map,this.events={access:new r.Observable},"string"!=typeof n)throw new TypeError}return e.configure=function(){return{make:function(){return!0},verify:function(){return!0},destroy:function(){return!0}}},e.prototype.get=function(e,t){var r=this;return void 0===t&&(t=o.noop),void this.events.access.emit([e],[[e],i.get]),void this.access(function(o){var i,a=o.transaction(r.name,n.IDBTransaction.readonly),s=r.index?a.objectStore(r.name).index(r.index).get(e):a.objectStore(r.name).get(e);s.onsuccess=function(t){return i=void 0!==s.result&&null!==s.result?s.result:r.cache.get(e)},a.oncomplete=function(e){return t(i,a.error)},a.onerror=a.onabort=function(e){return t(void 0,a.error)}}),this.cache.get(e)},e.prototype.set=function(e,t,r){return void 0===r&&(r=o.noop),this.put(t,e,r)},e.prototype.put=function(e,t,r){var a=this;return void 0===r&&(r=o.noop),void this.cache.set(t,e),void this.events.access.emit([t],[[t],i.put]),void this.access(function(e){if(a.cache.has(t)){var o=e.transaction(a.name,n.IDBTransaction.readwrite);a.index?o.objectStore(a.name).put(a.cache.get(t)):o.objectStore(a.name).put(a.cache.get(t),t);o.oncomplete=o.onerror=o.onabort=function(e){return void r(t,o.error)}}}),this.cache.get(t)},e.prototype["delete"]=function(e,t){var r=this;void 0===t&&(t=o.noop),void this.cache["delete"](e),void this.events.access.emit([e],[[e],i["delete"]]),void this.access(function(o){var i=o.transaction(r.name,n.IDBTransaction.readwrite);i.objectStore(r.name)["delete"](e);i.oncomplete=i.onerror=i.onabort=function(e){return void t(i.error)}})},e.prototype.cursor=function(e,t,r,n,o){var i=this;void this.access(function(a){var s=a.transaction(i.name,n),c=t?s.objectStore(i.name).index(t).openCursor(e,r):s.objectStore(i.name).openCursor(e,r);c.onsuccess=function(e){return c.result&&o(c.result,c.error)},s.oncomplete=function(e){return void o(null,s.error)},s.onerror=s.onabort=function(e){return void o(null,s.error)}})},e}();t.AbstractKeyValueStore=a}),define("src/layer/domain/indexeddb/model/schema/storage/access",["require","exports","src/layer/domain/indexeddb/model/store/key-value","src/layer/domain/indexeddb/model/store/event"],function(e,t,r,n){"use strict";t.STORE_NAME="access",t.STORE_FIELDS={key:"key",date:"date"};var o=function(){function e(e,t){this.key=e,this.date=t}return e}(),i=function(e){function r(r,i){var a=this;e.call(this,r,t.STORE_NAME,t.STORE_FIELDS.key),void i.monitor([],function(e){var t=e[0],r=e[2];return r===n.EventType["delete"]?void a["delete"](t):void a.set(t,new o(t,Date.now()))}),void Object.freeze(this)}return __extends(r,e),r.configure=function(){return{make:function(e){var r=e.objectStoreNames.contains(t.STORE_NAME)?e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME):e.createObjectStore(t.STORE_NAME,{keyPath:t.STORE_FIELDS.key,autoIncrement:!1});return r.indexNames.contains(t.STORE_FIELDS.key)||void r.createIndex(t.STORE_FIELDS.key,t.STORE_FIELDS.key,{unique:!0}),r.indexNames.contains(t.STORE_FIELDS.date)||void r.createIndex(t.STORE_FIELDS.date,t.STORE_FIELDS.date),!0},verify:function(e){return e.objectStoreNames.contains(t.STORE_NAME)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(t.STORE_FIELDS.key)&&e.transaction(t.STORE_NAME).objectStore(t.STORE_NAME).indexNames.contains(t.STORE_FIELDS.date)},destroy:function(){return!0}}},r}(r.AbstractKeyValueStore);t.AccessStore=i}),define("src/layer/domain/indexeddb/model/schema/storage",["require","exports","src/layer/infrastructure/indexeddb/api","src/layer/domain/indexeddb/model/types","src/layer/domain/indexeddb/model/store/event","src/layer/domain/indexeddb/model/schema/storage/data","src/layer/domain/indexeddb/model/schema/storage/access","src/lib/noop"],function(e,t,r,n,o,i,a,s){"use strict";t.StorageRecord=o.UnsavedEventRecord,t.EventType=o.EventType,t.StorageValue=i.DataValue;var c=function(){function e(e,t){this.name=e;var n=r.open(e,{make:function(e){return i.DataStore.configure().make(e)&&a.AccessStore.configure().make(e)},verify:function(e){return i.DataStore.configure().verify(e)&&a.AccessStore.configure().verify(e)},destroy:function(e,r){return i.DataStore.configure().destroy(e,r)&&a.AccessStore.configure().destroy(e,r)&&t(e,r)}});this.schema=new d(n),this.events=this.schema.data.events}return e.prototype.keys=function(e){return void 0===e&&(e=s.noop),this.schema.data.keys(e)},e.prototype.has=function(e){return this.schema.data.has(n.KeyString(e))},e.prototype.get=function(e){return this.schema.data.get(n.KeyString(e))},e.prototype.add=function(e){return void this.schema.data.add(e)},e.prototype["delete"]=function(e){void this.schema.data["delete"](n.KeyString(e))},e.prototype.recent=function(e,t){var n=[];void this.schema.access.cursor(null,a.STORE_FIELDS.date,r.IDBCursorDirection.prevunique,r.IDBTransaction.readonly,function(r,o){return r?void(--e<0||(void n.push(r.primaryKey),void r["continue"]())):void t(n,o)})},e.prototype.clean=function(e,t){void 0===e&&(e=1/0),void this.schema.data.clean(e,t&&n.KeyString(t))},e.prototype.destroy=function(){void r.destroy(this.name)},e}();t.Storage=c;var d=function(){function e(e){this.data=new i.DataStore(e),this.access=new a.AccessStore(e,this.data.events.access),void Object.freeze(this)}return e}()}),define("src/layer/infrastructure/webstorage/module/global",["require","exports","arch-stream"],function(e,t,r){"use strict";var n=function(){try{var e="localsocket#"+r.uuid();if(void self.sessionStorage.setItem(e,e),e!==self.sessionStorage.getItem(e))throw 1;return void self.sessionStorage.removeItem(e),!0}catch(t){return!1}}();t.localStorage=n?self.localStorage:void 0,t.sessionStorage=n?self.sessionStorage:void 0}),define("src/layer/infrastructure/webstorage/model/event",["require","exports","arch-stream","src/layer/infrastructure/webstorage/module/global"],function(e,t,r,n){"use strict";var o={localStorage:new r.Observable,sessionStorage:new r.Observable};t.events=o,void window.addEventListener("storage",function(e){switch(e.storageArea){case n.localStorage:return void o.localStorage.emit("storage",e);case n.sessionStorage:return void o.sessionStorage.emit("storage",e)}})}),define("src/layer/infrastructure/webstorage/api",["require","exports","src/layer/infrastructure/webstorage/module/global","src/layer/infrastructure/webstorage/model/event"],function(e,t,r,n){"use strict";t.localStorage=r.localStorage,t.sessionStorage=r.sessionStorage,t.events=n.events}),define("src/layer/domain/webstorage/service/event",["require","exports","arch-stream","src/layer/infrastructure/webstorage/api"],function(e,t,r,n){"use strict";function o(e){var t=new r.Observable;return void e.on("storage",function(e){return void t.emit(e.key,e)}),t}t.events={localStorage:o(n.events.localStorage),sessionStorage:o(n.events.sessionStorage)}}),define("src/layer/domain/webstorage/repository/store",["require","exports","arch-stream","src/layer/domain/dao/api","src/layer/domain/webstorage/service/event","src/layer/infrastructure/webstorage/api","src/lib/noop"],function(e,t,r,n,o,i,a){"use strict";function s(e,t,r,n,o){return void 0===t&&(t=i.sessionStorage),void 0===n&&(n=0),void 0===o&&(o={add:function(e,t){},"delete":function(e){}}),new v(e,t,r,n,o)}var c=new r.Set,d=(new r.Set,new r.Set),u=(new r.Set,function(){function e(e,t,r,n,o){this.type=e,this.key=t,this.attr=r,this.newValue=n,this.oldValue=o}return e}());t.StoreEvent=u,t.repository=s;var v=function(){function e(e,t,n,s,u){void 0===u&&(u={add:function(e,t){},"delete":function(e){}}),this.name=e,this.storage=t,this.factory=n,this.life=s,this.meta=u,this.event=new r.Observable,this.cache=this.storage===i.localStorage?c:d,this.eventSource=this.storage===i.localStorage?o.events.localStorage:o.events.sessionStorage,this.subscriber=a.noop,this.event.toJSON=function(){}}return e.prototype.link=function(){function e(e){try{return JSON.parse(e)}catch(t){return{}}}var t=this;if(this.cache.has(this.name))return this.cache.get(this.name);void this.close();var o=r.assign((s={},s[n.SCHEMA.KEY.NAME]=this.name,s[n.SCHEMA.EVENT.NAME]=this.event,s),e(this.storage.getItem(this.name)||"{}"));o.__event.toJSON=function(){};var a=n.build(o,this.factory,function(e,r,n){t.storage===i.localStorage&&null===t.storage.getItem(t.name)&&void t.meta.add(t.name,t.life),void t.storage.setItem(t.name,JSON.stringify(o)),void t.event.emit(["send",e],new u("send",t.name,e,r,n))});return this.subscriber=function(r){var i=r.newValue,a=r.oldValue;if(i){var s=e(i);void Object.keys(s).filter(n.isValidPropertyName).filter(n.isValidPropertyValue(s)).reduce(function(e,t){var r=[s[t],o[t]],n=r[0],i=r[1];n!==i&&(o[t]=n)},void 0)}void t.event.emit(["recv"],new u("recv",t.name,void 0,i,a))},void this.eventSource.on(this.name,this.subscriber),void this.cache.add(this.name,a),void this.storage.setItem(this.name,JSON.stringify(o)),void this.meta.add(this.name,this.life),a;var s},e.prototype.close=function(){void this.eventSource.off(this.name,this.subscriber),void this.cache["delete"](this.name)},e.prototype.destroy=function(){void this.close(),void this.storage.removeItem(this.name),void this.meta["delete"](this.name)},e}()}),define("src/layer/domain/indexeddb/repository/socket",["require","exports","arch-stream","src/layer/domain/dao/api","src/layer/domain/indexeddb/model/schema/storage","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/repository/store","src/layer/domain/indexeddb/model/types","src/layer/domain/lib/assign"],function(e,t,r,n,o,i,a,s,c){"use strict";function d(e,t,r){return new l(e,t,r)}t.socket=d;var u=function(){function e(e,t,r){this.key=e,this.attr=t,this.date=r}return e}(),v=function(){function e(){this.msgs=[],this.msgHeadSet_=new r.Set(function(e,t){return t>e?t:e})}return e.prototype.recv=function(){var e=this;return this.msgs.filter(function(t){return!e.msgHeadSet_.has(t.key)||t.date>e.msgHeadSet_.get(t.key)}).filter(function(t){return!void e.msgHeadSet_.add(t.key,t.date)})},e.prototype.send=function(e){this.msgs=r.concat([e],this.msgs.slice(0,9))},e}(),l=function(e){function t(t,s,c){var d=this;e.call(this,t,c),this.factory=s,this.proxy=a.repository(this.name,i.localStorage,function(){return new v}),this.port=this.proxy.link(),this.links=new r.Set,this.sources=new r.Set,void this.port.__event.monitor([],function(e){var t=e.type;e.newValue;switch(t){case"send":return;case"recv":return void d.port.recv().reduce(function(e,t){return void d.schema.data.update(t.key)},void 0)}}),void this.events.save.monitor([],function(e){var t=e[0],r=e[1];void d.port.send(new u(t,r,Date.now()))}),void this.events.load.monitor([],function(e){var t=e[0],r=e[1],i=e[2],s=d.sources.get(t);if(s)switch(i){case o.EventType.put:var c=s[r],u=d.get(t)[r];return s[r]=u,void void s.__event.emit(["recv",r],new a.StoreEvent("recv",t,r,u,c));
case o.EventType["delete"]:var v=d.get(t);return void void Object.keys(v).filter(n.isValidPropertyName).filter(n.isValidPropertyValue(v)).reduce(function(e,r){var n=s[r],o=void 0;s[r]=o,void s.__event.emit(["recv",r],new a.StoreEvent("recv",t,r,o,n))},void 0);case o.EventType.snapshot:var l=d.get(t);return void void Object.keys(l).filter(n.isValidPropertyName).filter(n.isValidPropertyValue(l)).reduce(function(e,r){var n=s[r],o=l[r];s[r]=o,void s.__event.emit(["recv",r],new a.StoreEvent("recv",t,r,o,n))},void 0)}})}return __extends(t,e),t.prototype.link=function(e){var t=this;if(this.links.has(e))return this.links.get(e);var i=this.sources.add(e,c.assign((u={},u[n.SCHEMA.KEY.NAME]=e,u[n.SCHEMA.EVENT.NAME]=new r.Observable,u),this.get(e)));i.__event.toJSON=function(){};var d=this.links.add(e,n.build(i,this.factory,function(r,n,c){void t.add(new o.StorageRecord(s.KeyString(e),(d={},d[r]=n,d))),void i.__event.emit(["send",r],new a.StoreEvent("send",e,r,n,c));var d}));return d;var u},t.prototype.close=function(){void this.proxy.close()},t.prototype.destroy=function(){void this.close(),void this.proxy.destroy(),void e.prototype.destroy.call(this)},t}(o.Storage)}),define("src/layer/domain/indexeddb/service/event",["require","exports","src/layer/infrastructure/indexeddb/api"],function(e,t,r){"use strict";t.event=r.event}),define("src/layer/domain/indexeddb/api",["require","exports","src/layer/domain/indexeddb/repository/socket","src/layer/domain/indexeddb/service/event"],function(e,t,r,n){"use strict";t.socket=r.socket,t.event=n.event}),define("src/layer/domain/webstorage/service/meta",["require","exports","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/repository/store"],function(e,t,r,n){"use strict";var o=function(){function e(){this.expires={}}return e.prototype.add=function(e,t){this.expires[e]=this.expires[e]||new i(e,new a(t))},e.prototype["delete"]=function(e){delete this.expires[e]},e.prototype.commit=function(){this.expires=this.expires},e.prototype.entries=function(){var e=this;return Object.keys(this.expires).map(function(t){return[t,e.expires[t]]})},e}();t.WebStorageMetaData=o;var i=function(){function e(e,t){this.name=e,this.expire=t}return e}(),a=function(){function e(e){this.life=e,this.atime=Date.now(),this.rest=this.life}return e}(),s="localsocket::meta";t.meta=n.repository(s,r.localStorage,function(){return new o},1/0).link()}),define("src/layer/domain/webstorage/service/clean",["require","exports","src/layer/domain/webstorage/repository/store"],function(e,t,r){"use strict";function n(e,t,n){void 0===n&&(n=Date.now()),t&&(void e.entries().reduce(function(o,i){var a=i[0],s=i[1].expire;s.atime+864e5>n?s.rest=s.life:(s.atime=n,void--s.rest),s.rest<0&&void r.repository(a,t,function(){return{}},0,e).destroy()},void 0),void e.commit())}t.clean=n}),define("src/layer/domain/webstorage/api",["require","exports","src/layer/domain/webstorage/repository/store","src/layer/domain/webstorage/service/meta","src/layer/domain/webstorage/service/clean","src/layer/infrastructure/webstorage/api","src/layer/infrastructure/webstorage/api","src/layer/domain/webstorage/service/event"],function(e,t,r,n,o,i,a,s){"use strict";function c(e,t,o,a){return r.repository(e,t,o,a,t===i.localStorage?n.meta:void 0)}t.localStorage=a.localStorage,t.sessionStorage=a.sessionStorage,t.events=s.events,t.webstorage=c,void o.clean(n.meta,i.localStorage),void setInterval(function(){return void o.clean(n.meta,i.localStorage)},36e5)}),define("src/layer/app/api",["require","exports","src/layer/app/module/config","src/layer/domain/indexeddb/api","src/layer/domain/webstorage/api","src/layer/domain/indexeddb/api","src/layer/domain/webstorage/api"],function(e,t,r,n,o,i,a){"use strict";function s(e,t){return t=r.configure(t),n.socket(e,t.factory,t.destroy)}function c(e,t,n){switch(n=r.configure(n),t){case o.localStorage:return o.webstorage(e,o.localStorage,n.factory,n.life);case o.sessionStorage:return o.webstorage(e,o.sessionStorage,n.factory,n.life)}throw new TypeError("LocalSocket: Invalid storage type "+t)}t.socket=s,t.store=c;var d;!function(e){e.indexedDB=i.event,e.localStorage=a.events.localStorage,e.sessionStorage=a.events.sessionStorage}(d=t.events||(t.events={}))}),define("src/layer/interface/api",["require","exports","src/layer/app/api","src/layer/app/api"],function(e,t,r,n){"use strict";function o(e,t,n){return void 0===t&&(t=indexedDB),void 0===n&&(n={}),t===indexedDB?r.socket(e,n):r.store(e,t,n)}t.localsocket=o,t.events=n.events}),define("src/export",["require","exports","src/layer/interface/api"],function(e,t,r){"use strict";t["default"]=r.localsocket}),define("localsocket",["require","exports","src/export","src/export"],function(e,t,r,n){"use strict";function o(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}o(r),t["default"]=n["default"]}),define("src/layer/domain/indexeddb/model/api",["require","exports","src/layer/infrastructure/indexeddb/api"],function(e,t,r){"use strict";t.IDBKeyRange=r.IDBKeyRange});